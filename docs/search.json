[
  {
    "objectID": "index.html",
    "href": "index.html",
    "title": "Resistance genes in Escherichia coli",
    "section": "",
    "text": "Sara Burgess, 14 November 2025\nSankey diagrams are used to illustrate flows from one item (node) to another. There are several R packages used to generate Sankey diagrams. This blog will demonstrate how to use the networkD3 and ggsankey packages.\n\n\nIn these examples data was manually sourced from publications (as listed at the bottom of this blog) to visualise the different resistance genes and mechanisms that the bacterium Escherichia coli can use to become resistant to seven classes of antibiotics. The first Sankey diagram covers E. coli resistance to six classes of antibiotics (aminoglycosides, fluoroquinolones, tetracyclines, phenicols, sulfonamides and trimethoprim, nitrofurans). The second Sankey diagram shows how different beta-lactamase enzyme types confer resistance to different sub-classes of beta-lactams.\n\n\n\nThe package networkD3 can be used for generating a variety of interactive network (as described in this geeksforgeeks blog.\n\n\nIf you haven’t done so already install the packages networkD3, tidyverse, htmlwidgets, manipulateWidget and webshot2.\nLoad the libraries\n\nlibrary(networkD3)\nlibrary(tidyverse)\nlibrary(htmlwidgets)\nlibrary(manipulateWidget)\nlibrary(webshot2)\nlibrary(paletteer)\n\n\n\n\nThe following code was adapted from the r-graph-gallery . Two data frames are needed to generate a Sankey diagram. One for the links and the other for the nodes. First read in your data for the links data frame.\n\nlinks &lt;- read_csv(\"data/resistance_mechanisms.csv\")\n\nRows: 75 Columns: 3\n── Column specification ────────────────────────────────────────────────────────\nDelimiter: \",\"\nchr (2): source, target\ndbl (1): value\n\nℹ Use `spec()` to retrieve the full column specification for this data.\nℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.\n\n\nMy csv file contains three columns: source, target, value. Source is the origin of each data link. Given, my Sankey diagram has three columns, source contains both the names of the antibiotic classes and the mechanisms. Target is the endpoint of each data link. This contains the mechanisms and resistance genes. Value is the thickness of each link.\n\n#First six lines of my data frame\nhead(links)\n\n# A tibble: 6 × 3\n  source           target                 value\n  &lt;chr&gt;            &lt;chr&gt;                  &lt;dbl&gt;\n1 Aminoglycosides  Enzymatic inactivation    14\n2 Aminoglycosides  Target alteration          8\n3 Aminoglycosides  Efflux pump                2\n4 Fluoroquinolones Enzymatic inactivation     2\n5 Fluoroquinolones Target alteration          8\n6 Fluoroquinolones Target protection          2\n\n#Last six lines of my data frame\ntail(links)\n\n# A tibble: 6 × 3\n  source      target value\n  &lt;chr&gt;       &lt;chr&gt;  &lt;dbl&gt;\n1 Efflux pump mphA       2\n2 Efflux pump mphB       2\n3 Efflux pump mefA       2\n4 Efflux pump mefB       2\n5 Efflux pump msrA       2\n6 Efflux pump msrD       2\n\n\nThe ' in some of my gene names is read in as ? so first I replaced the ? with ′.\n\nlinks$target &lt;- str_replace_all(links$target, \"\\\\?\", \"′\") \n\nNext I created a one column data frame for all the nodes. The column name is labelled name and the observations are all the unique names from source and target.\n\nnodes &lt;- data.frame(\n  name = unique(c(as.character(links$source), as.character(links$target))))\n\nA second column was added to the nodes data frame called group. This will be used to colour the Sankey diagram links by group.\n\n# Grouping\nnodes$group &lt;- case_when(\n  nodes$name == \"Aminoglycosides\" ~ \"Aminoglycosides\",\n  nodes$name == \"Fluoroquinolones\" ~ \"Fluoroquinolones\",\n  nodes$name == \"Tetracyclines\" ~ \"Tetracyclines\",\n  nodes$name == \"Phenicols\" ~ \"Phenicols\",\n  nodes$name == \"Sulfonamides & Trimethoprim\" ~ \"Sulfonamides\",\n  nodes$name == \"Nitrofurans\" ~ \"Nitrofurans\",\n  nodes$name == \"Macrolides\" ~ \"Macrolides\",\n  nodes$name %in% c(\"aac(3′)\", \"aadA\", \"aadB\", \"aadD\",\n                    \"aph(3′)\", \"aphA15\", \"rrsH*\", \"rsmG*\") ~ \"Aminoglycosides\",\n  nodes$name %in% c(\"gyrA*\", \"gyrB*\", \"parC*\", \"parE*\", \"qep\", \"qnr\", \"oqxAB\") ~ \"Fluoroquinolones\",\n  nodes$name %in% c(\"tetX\", \"tetM\", \"tetW\", \"tetA\", \"tetB\", \"tetC\", \"tetD\") ~ \"Tetracyclines\",\n  nodes$name %in% c(\"catB\", \"catII\", \"cmlA\", \"floR\") ~ \"Phenicols\",\n  nodes$name %in% c(\"dfr\", \"folP*\", \"sul1\", \"sul2\", \"sul3\", \"sul4\") ~ \"Sulfonamides\",\n  nodes$name %in% c(\"nfsA*\", \"nfsB*\", \"ahpF*\", \"ribB*\", \"ribE*\") ~ \"Nitrofurans\",\n  nodes$name %in% c(\"ermA\", \"ermB\", \"ermC\", \"ereA\", \"mphA\", \"mphB\", \"mefA\", \"mefB\", \"msrA\", \"msrD\") ~ \"Macrolides\",\n  TRUE ~ \"Other\"\n)\n\nTwo additional columns were added, which contain an index for both the source and the target. The match function is used to match the position of the values that are being matched. As I understand it networkD3 uses an index system starting from 0, whereas base R starts from 1, hence the -1 is needed to generate an index system suitable for the function networkD3::sankeyNetwork().\n\n# ID mapping\nlinks$IDsource &lt;- match(links$source, nodes$name) - 1\nlinks$IDtarget &lt;- match(links$target, nodes$name) - 1\n\nlinks\n\n# A tibble: 75 × 5\n   source           target                 value IDsource IDtarget\n   &lt;chr&gt;            &lt;chr&gt;                  &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;\n 1 Aminoglycosides  Enzymatic inactivation    14        0        7\n 2 Aminoglycosides  Target alteration          8        0        8\n 3 Aminoglycosides  Efflux pump                2        0        9\n 4 Fluoroquinolones Enzymatic inactivation     2        1        7\n 5 Fluoroquinolones Target alteration          8        1        8\n 6 Fluoroquinolones Target protection          2        1       10\n 7 Fluoroquinolones Efflux pump                6        1        9\n 8 Tetracyclines    Enzymatic inactivation     2        2        7\n 9 Tetracyclines    Target alteration          4        2        8\n10 Tetracyclines    Target protection          4        2       10\n# ℹ 65 more rows\n\n\nSimilar to the nodes data frame a group column was also added to the links data frame.\n\n#Generate vector containing the group names for all the antibiotic classes\nclass &lt;- c(\"Aminoglycosides\", \"Fluoroquinolones\", \"Tetracyclines\", \"Phenicols\", \"Sulfonamides & Trimethoprim\", \"Nitrofurans\", \"Macrolides\")\n#Generate vector containing the group names for all the mechanisms\nmechanisms &lt;- c(\"Enzymatic inactivation\", \"Target alteration\", \"Target protection\", \"Efflux pump\", \"Target replacement\", \"Reduced prodrug activation\")\n\n# Assign groups\nlinks$group &lt;- case_when(\n  links$source %in% class ~ nodes$group[match(links$source, nodes$name)],\n  links$source %in% mechanisms ~ nodes$group[match(links$target, nodes$name)],\n  TRUE ~ \"Other\")\n\nLastly I generated my colour scale. Here because networkD3 uses Javascript code the colour scale also has to be written in Javascript. '.domain' defines each group that I want to apply each colour to.\n\nmy_color &lt;- 'd3.scaleOrdinal()\n  .domain([\"Aminoglycosides\", \"Fluoroquinolones\", \"Tetracyclines\", \n           \"Phenicols\", \"Sulfonamides\", \"Nitrofurans\", \"Macrolides\", \"Other\"])\n  .range([\"#90CAF9\", \"#A5D6A7\", \"#D1C4E9\", \"#ffffb3\", \"#fb8072\", \"#fdb462\", \"#F8BBD0FF\", \"#E0E0E0\"]);'\n\n\n\n\nNow for the fun part generating the Sankey diagram.\n\n# Sankey plot\nq &lt;- sankeyNetwork(\n  Links = links, Nodes = nodes,\n  Source = \"IDsource\", Target = \"IDtarget\",\n  Value = \"value\", NodeID = \"name\",\n  NodeGroup = \"group\", LinkGroup = \"group\",\n  colourScale = my_color,\n  width = 900, height = 900,\n  nodeWidth = 60\n)\nq\n\n\n\n\n\nThere are a few things I don’t like. The font size and type, as well as having the resistance genes on top of the links.\nHere I’ve adjusted these three things within the sankeyNetwork() function using the arguments fontSize, fontFamily, and sinksRight.\n\n# Sankey plot\np &lt;- sankeyNetwork(\n  Links = links, Nodes = nodes,\n  Source = \"IDsource\", Target = \"IDtarget\",\n  Value = \"value\", NodeID = \"name\",\n  NodeGroup = \"group\", LinkGroup = \"group\",\n  colourScale = my_color,\n  fontSize = 12, fontFamily = \"Verdana\", nodeWidth = 60, sinksRight = FALSE, width = 900, height = 900\n)\np\n\n\n\n\n\nIt’s still not quite what I’d like. To my knowledge that is pretty much all that can be adjusted within the SankeyNetwork() function. However, because the Sankey diagram is an htmlwidget (you can check this using the class function) you can use the htmlwidgets package to append labels.\n\nclass(p)\n\n[1] \"sankeyNetwork\" \"htmlwidget\"   \n\n\n\n\n\nThe code below was adapted from this tutorial and the response on this stack overflow post.\nFirst I added a title to my diagram.\n\n#prepend title\np1 &lt;- htmlwidgets::prependContent(p, htmltools::tags$h1(htmltools::HTML(\"Resistance genes in &lt;em&gt;Escherichia coli&lt;/em&gt;\"),\n  style = \"text-align:center; color:#1b2422; font-size:18px; font-family:Verdana;\"))\n\nNext a footnote was added.\n\n#append footnote\np2 &lt;- htmlwidgets::appendContent(p1, htmltools::tags$p(\"* Genes with point mutations\", style = \"text-align:center; color:#666; font-size:12px; font-family:Verdana;\"))\np2\n\n\n\n* Genes with point mutations\n\n\n\nI also changed the font style to bold for the antibiotic classes and italics for the resistance genes.\n\n#The following function was generated using chapgpt\np3 &lt;- htmlwidgets::onRender(p2, '\n  function(el, x) {\n    const boldNames = [\n      \"Aminoglycosides\", \"Fluoroquinolones\", \"Tetracyclines\",\n      \"Phenicols\", \"Sulfonamides & Trimethoprim\", \"Nitrofurans\",\n      \"Enzymatic inactivation\", \"Target alteration\",\n      \"Target protection\", \"Efflux pump\", \"Target replacement\",\n      \"Reduced prodrug activation\", \"Macrolides\"\n    ];\n\n    const italicSubstrings = [\n      \"aac\", \"aad\", \"aph\", \"rr\", \"rsm\", \"qep\", \"qnr\", \"tet\", \"cat\",\n      \"gyr\", \"par\", \"mdf\", \"fol\", \"dfr\", \"nfs\", \"cml\", \"flo\", \"oqx\", \"sul\",\n      \"erm\", \"ereA\", \"mph\", \"mef\", \"msr\", \"ahpF\", \"rib\"\n    ];\n\n    d3.select(el)\n      .selectAll(\".node text\")\n      .style(\"font-weight\", d =&gt; boldNames.includes(d.name) ? \"bold\" : \"normal\")\n      .style(\"font-style\", d =&gt;\n        italicSubstrings.some(sub =&gt; d.name.includes(sub)) ? \"italic\" : \"normal\"\n      );\n  }\n')\n\np3\n\n\n\n* Genes with point mutations\n\n\n\n\n\n\n\nIf you are trying this code or similar and want to save your plot as a png you will not be able to use the ggsave() function because the Sankey diagram is an htmlwidget. First save your plot as an html and then take a screenshot using webshot.\n\nhtmlwidgets::saveWidget(p3, \"output/sankey.html\", selfcontained = TRUE)\nwebshot(\"output/sankey.html\", file = \"output/sankey_arg.png\", vwidth = 900, vheight = 900)\n\n\n\n\nIn this example I used the package ggsankey to generate a Sankey diagram. Visualising the beta-lactam resistance genes was not as straight forward as the other resistance genes in the Sankey diagram above. There are multiple enzyme types, which all have a large number of variants. Certain variants have a wider range of resistance compared with their parent types, which adds in more complexity. For this reason I started with the genes on the left hand side.\n\n\nInstall the packages ggsankey, showtext and sysfonts, glue, patchwok and ggtext then load the libraries\n\n#remotes::install_github(\"davidsjoberg/ggsankey\")\n\nlibrary(ggsankey)\nlibrary(patchwork)\nlibrary(glue)\nlibrary(showtext)\nlibrary(sysfonts)\nlibrary(ggtext)\n\n\n\n\nNext read in the data.\n\ndf &lt;- read_csv(\"data/betalactams_gsankey.csv\")\n\nMy csv file contains three columns: “gene”, “mechanism”, “subclass”. This data frame is set up differently to the dataframe used for the first Sankey diagram in that each column will be a column in the Sankey diagram. The first column “gene” is the name of each resistance gene. The second column is the mechanism or type of enzyme. Instead of having “enzymatic inactivation” I divided the beta-lactamases into “Penicillinases”, “Oxcillinases”, “IRT” (inhibitor resistant TEM), “ESBL”, “AmpC”, and “Carbapenemases”. In addition, I included the mechanisms “reduced permeability” and “efflux pump”. The third column is the antibiotic subclass. Given most genes confer resistance to multiple sub classes there are multiple rows for each gene.\n\n#Structure of my dataframe\nstr(df)\n\nspc_tbl_ [121 × 3] (S3: spec_tbl_df/tbl_df/tbl/data.frame)\n $ gene     : chr [1:121] \"ompC*\" \"ompC*\" \"ompC*\" \"ompC*\" ...\n $ mechanism: chr [1:121] \"Reduced permeability\" \"Reduced permeability\" \"Reduced permeability\" \"Reduced permeability\" ...\n $ subclass : chr [1:121] \"NS penicillins\" \"ES penicillins\" \"1G cephalosporins\" \"3G cephalosporins\" ...\n - attr(*, \"spec\")=\n  .. cols(\n  ..   gene = col_character(),\n  ..   mechanism = col_character(),\n  ..   subclass = col_character()\n  .. )\n - attr(*, \"problems\")=&lt;externalptr&gt; \n\n#First six lines of my data frame\nhead(df)\n\n# A tibble: 6 × 3\n  gene  mechanism            subclass         \n  &lt;chr&gt; &lt;chr&gt;                &lt;chr&gt;            \n1 ompC* Reduced permeability NS penicillins   \n2 ompC* Reduced permeability ES penicillins   \n3 ompC* Reduced permeability 1G cephalosporins\n4 ompC* Reduced permeability 3G cephalosporins\n5 ompC* Reduced permeability Carbapenems      \n6 ompF* Reduced permeability NS penicillins   \n\n#Last six lines of my data frame\ntail(df)\n\n# A tibble: 6 × 3\n  gene     mechanism      subclass         \n  &lt;chr&gt;    &lt;chr&gt;          &lt;chr&gt;            \n1 blaNDM-1 Carbapenemases Carbapenems      \n2 blaIMP-4 Carbapenemases 1G cephalosporins\n3 blaIMP-4 Carbapenemases 2G cephalosporins\n4 blaIMP-4 Carbapenemases 3G cephalosporins\n5 blaIMP-4 Carbapenemases 4G cephalosporins\n6 blaIMP-4 Carbapenemases Carbapenems      \n\n#The unique mechanisms / enzyme types\nunique(df$mechanism)\n\n[1] \"Reduced permeability\" \"Efflux pump\"          \"Penicillinases\"      \n[4] \"Oxcillinases\"         \"IRT\"                  \"ESBL\"                \n[7] \"AmpC\"                 \"Carbapenemases\"      \n\n#The unique subclasses of antibiotics\nunique(df$subclass)\n\n[1] \"NS penicillins\"    \"ES penicillins\"    \"1G cephalosporins\"\n[4] \"3G cephalosporins\" \"Carbapenems\"       \"4G cephalosporins\"\n[7] \"Monobactams\"       \"2G cephalosporins\"\n\n\nNext, the data was converted to a long format using a function make_long() from the ggsankey package. This long format contains columns that define how the links flow through the diagram:\n\nx: the name of the current column (called a stage) on the x axis.\nnext_x: the name of the next stage (NA for the final stage which is why the subclass rows have NA values).\nnode: the value at the starting node.\nnext_node: the value at the connecting node.\n\nThe following code was adapted from the r-graph-gallery.\n\ndf_long &lt;- df %&gt;%\n        make_long(gene, mechanism, subclass)\n\nhead(df_long)\n\n# A tibble: 6 × 4\n  x         node                 next_x    next_node           \n  &lt;fct&gt;     &lt;chr&gt;                &lt;fct&gt;     &lt;chr&gt;               \n1 gene      ompC*                mechanism Reduced permeability\n2 mechanism Reduced permeability subclass  NS penicillins      \n3 subclass  NS penicillins       &lt;NA&gt;      &lt;NA&gt;                \n4 gene      ompC*                mechanism Reduced permeability\n5 mechanism Reduced permeability subclass  ES penicillins      \n6 subclass  ES penicillins       &lt;NA&gt;      &lt;NA&gt;                \n\n\nHere is a first look at how the data looks when it is plotted.\n\nggplot(df_long, aes(x = x, next_x = next_x, node = node, next_node = next_node)) +\n        geom_sankey()\n\n\n\n\n\n\n\n\nHere is the same plot with the links and nodes coloured by node.\n\nggplot(df_long, aes(x = x, next_x = next_x, node = node, next_node = next_node,\n                    fill = factor(node))) +\n        geom_sankey() +\n        scale_fill_discrete(drop = FALSE)\n\n\n\n\n\n\n\n\nThere is a lot to tidy up. First I removed the grey background, the grid, and x and y axis labels. I find that using theme_void() is the easiest way to do this. I also removed the legend using show.legend = FALSE.\n\nggplot(df_long, aes(x = x, next_x = next_x, node = node, next_node = next_node,\n                    fill = factor(node))) +\n        geom_sankey(show.legend = FALSE) +\n        scale_fill_discrete(drop = FALSE) +\n        theme_void()\n\n\n\n\n\n\n\n\nNext I added node labels.\n\nggplot(df_long, aes(x = x, next_x = next_x, node = node, next_node = next_node,\n                    fill = factor(node))) +\n        geom_sankey(show.legend = FALSE) +\n        geom_sankey_text(aes(label = node)) +\n        scale_fill_discrete(drop = FALSE) +\n        theme_void()\n\n\n\n\n\n\n\n\nI wanted to change the colours of the links so that each gene would be coloured according to its mechanism using a more visually appealing colour palette compared with the default colours. First an extra column was added to the long dataframe to group the genes and mechanism rows by mechanism.\n\nmechanism_lookup &lt;- df %&gt;%\n        select(gene, mechanism) %&gt;%\n        rename(node = gene) %&gt;%\n        bind_rows(\n                df %&gt;% \n                        distinct(mechanism) %&gt;% \n                        rename(node = mechanism) %&gt;% \n                        mutate(mechanism = node)) %&gt;%\n        distinct()\n\n# Add mechanism info to the long data\ndf_long_coloured &lt;- df_long %&gt;%\n        left_join(mechanism_lookup, by = \"node\")\n\nhead(df_long_coloured)\n\n# A tibble: 6 × 5\n  x         node                 next_x    next_node            mechanism       \n  &lt;fct&gt;     &lt;chr&gt;                &lt;fct&gt;     &lt;chr&gt;                &lt;chr&gt;           \n1 gene      ompC*                mechanism Reduced permeability Reduced permeab…\n2 mechanism Reduced permeability subclass  NS penicillins       Reduced permeab…\n3 subclass  NS penicillins       &lt;NA&gt;      &lt;NA&gt;                 &lt;NA&gt;            \n4 gene      ompC*                mechanism Reduced permeability Reduced permeab…\n5 mechanism Reduced permeability subclass  ES penicillins       Reduced permeab…\n6 subclass  ES penicillins       &lt;NA&gt;      &lt;NA&gt;                 &lt;NA&gt;            \n\n\nI selected my colours using the r-graph-gallery color-palette-finder. Shades of blue from the seeblau palette were used for the “Reduced permeability” and “Efflux pump” mechanisms. Shades of yellow, orange, and red from the amber_material palette were used for the beta-lactamase enzyme types.\n\n#The two palettes that I selected my colours from:\npaletteer_d(\"unikn::pal_seeblau\")\n\n&lt;colors&gt;\n#CCEEF9FF #A6E1F4FF #59C7EBFF #00A9E0FF #008ECEFF \n\npaletteer_d(\"ggsci::amber_material\")\n\n&lt;colors&gt;\n#FFF8E1FF #FFECB3FF #FFE082FF #FFD54FFF #FFCA28FF #FFC107FF #FFB300FF #FFA000FF #FF8F00FF #FF6F00FF \n\n\nI defined my colour palette. All the antibiotic classes were defined as “other”.\n\nmy_colour &lt;- c(\n        \"Reduced permeability\" = \"#A6E1F4FF\",      \n        \"Efflux pump\" = \"#0F7BA2FF\",         \n        \"Penicillinases\" = \"#FFECB3FF\",\n        \"Oxcillinases\" = \"#FFD54FFF\", \n        \"IRT\" = \"#FFC107FF\", \n        \"ESBL\" = \"#FFA000FF\",\n        \"AmpC\" = \"#FF6F00FF\", \n        \"Carbapenemases\" = \"#DA291CFF\",\n        \"Other\" = \"#B3B7B8FF\" )\n\nI filled the links by the new mechanism variable.\n\nggplot(\n        df_long_coloured, \n        aes(x = x, next_x = next_x, node = node, next_node = next_node,\n                    fill = mechanism)) +\n        geom_sankey(show.legend = FALSE) +\n        geom_sankey_text(aes(label = node)) +\n        scale_fill_discrete(drop = FALSE) +\n        theme_void()\n\n\n\n\n\n\n\n\nAlthough I now have the same colour for each mechanism, my colour palette has not been used therefore, scale_fill_discrete() was changed to scale_fill_manual(). The colours on the links were very bright so to make them slightly transparent I used the argument flow.alpha.\n\nggplot(\n        df_long_coloured, \n        aes(x = x, next_x = next_x, node = node, next_node = next_node,\n                    fill = mechanism)) +\n        geom_sankey(show.legend = FALSE) +\n        geom_sankey_text(aes(label = node)) +\n        scale_fill_manual(values = my_colour) +\n        theme_void() \n\n\n\n\n\n\n\n\nNext I left justified the first column labels and right justified the second column labels. This code was adapted from this stack overflow post. Here the function stage() was used to control the stage at which the aesthetics should be mapped.\n\nggplot(\n        df_long_coloured, \n        aes(x = x, next_x = next_x,\n        node = node, next_node = next_node,\n        fill = mechanism, label = node)) +\n        geom_sankey(flow.alpha = 0.7,\n                show.legend = FALSE) +\n        geom_sankey_text(\n                aes(\n          x = stage(x, after_stat = x + 0.1 * case_when(\n                                                  x == 1 ~ -1,    \n                                                  x == 3 ~ 1,     \n                                                  .default = 0)),\n                    hjust = case_when(x == \"gene\" ~ 1,        \n                            x == \"subclass\" ~ 0, \n                            .default = 0.5))) +\n        theme_void() +\n        scale_fill_manual(values = my_colour)\n\n\n\n\n\n\n\n\nNext I reordered the nodes. See this link for more explanation on how to reorder nodes.\n\ndf_long_coloured2 &lt;- df_long_coloured\n\ndf_long_coloured2$node &lt;- factor(\n  df_long_coloured$node, \n  levels = rev(c(\n    \"ompC*\", \"Reduced permeability\", \"ompF*\", \n    \"acrAB-tolC*\", \"Efflux pump\", \n    \"blaTEM-1\", \"Penicillinases\", \"blaSHV-1\", \n    \"blaOXA-1\", \"Oxcillinases\", \n    \"blaTEM-30\", \"IRT\", \n    \"blaTEM-10\", \"ESBL\", \"blaSHV-12\", \"blaCTX-M-15\", \n    \"blaGES-3\", \"blaVEB-1\", \"blaROB-1\", \"blaTLA-1\", \n    \"ampC*\", \"AmpC\", \n    \"blaCMY-2\", \"blaDHA-1\", \"blaFOX-1\", \"blaACC-4\", \n    \"blaKPC-18\", \"Carbapenemases\", \n    \"blaOXA-48\", \"blaNDM-1\", \"blaIMP-4\",\n    \"NS penicillins\", \"ES penicillins\", \"Monobactams\", \n    \"1G cephalosporins\", \"2G cephalosporins\", \n    \"3G cephalosporins\", \"4G cephalosporins\", \"Carbapenems\"))\n)\n\ndf_long_coloured2$next_node &lt;- factor(\n  df_long_coloured$next_node, \n  levels = rev(c(\"Reduced permeability\", \"Efflux pump\", \"Penicillinases\", \n    \"Oxcillinases\", \"IRT\", \"ESBL\", \"AmpC\", \"Carbapenemases\",\n    \"NS penicillins\", \"ES penicillins\",\"Monobactams\",\"1G cephalosporins\",\n    \"Carbapenems\",\"2G cephalosporins\",\"3G cephalosporins\", \"4G cephalosporins\"))\n)\n\nThe plot with the reordered nodes.\n\nggplot(df_long_coloured2, aes(\n        x = x, next_x = next_x,\n        node = node, next_node = next_node,\n        fill = mechanism, label = node)) +\n        geom_sankey(flow.alpha = 0.7,\n                show.legend = FALSE) +\n        geom_sankey_text(aes(\n          x = stage(x, after_stat = x + 0.1 *case_when(\n                                                  x == 1 ~ -1,    \n                                                  x == 3 ~ 1,     \n                                                  .default = 0)),\n                    hjust = case_when(x == \"gene\" ~ 1,        \n                            x == \"subclass\" ~ 0, \n                            .default = 0.5))) +\n        theme_void() +\n        scale_fill_manual(values = my_colour)\n\n\n\n\n\n\n\n\nI italicised the gene names and changed the mechanisms to a bold style using plotmath syntax. First I added another column, which will be used for plotmath syntax, called label_pms. For example, to generate x in italic font use italic(x). Go to this link to read more on plotmath syntax. The paste() function was used to join strings together with no separator. I joined either the string \"italic('\", \"bold('\", or \"plain('\" with the node value (so the gene name), and the string \"')\". Then I changed those labels with a bla gene so that the enzyme type was written in subscript. The function str_replace_all() was used to replace any text with the literal string italic\\\\( followed by bla with the pattern of three word characters\\\\w{3}, a literal hyphen -, one word character \\\\w followed by one or more digits \\\\d or (|) the pattern of three word characters, hyphen, multiple digits.\n\n#Add a new column called label_pms with the plotmath syntax for font styling\ndf_long_coloured3 &lt;- df_long_coloured2 %&gt;%\n  mutate(label_pms = case_when(\n    x == \"gene\" ~ paste0(\"italic('\", node, \"')\"),          \n    x == \"mechanism\" ~ paste0(\"bold('\", node, \"')\"),       \n    x == \"subclass\" ~ paste0(\"plain('\", node, \"')\")        \n  ))\n\n#Change the bla gene labels to subscript after bla\ndf_long_coloured3 &lt;- df_long_coloured3 %&gt;%\n  mutate(label_pms = str_replace_all(label_pms,                                \"italic\\\\('(bla)(\\\\w{3}-\\\\w-\\\\d+|\\\\w{3}-\\\\d+)'\\\\)\", \n                               \"italic('\\\\1')[\\\\2]\"))\n\nNote that when you change the order of your nodes, you also need to set the levels for your labels so that they match the same order as your nodes.\n\ndf_long_coloured3$label_pms &lt;- factor(\n  df_long_coloured3$label_pms,\n  levels = rev(c(\n    \"italic('ompC*')\",\n    \"bold('Reduced permeability')\",\n    \"italic('ompF*')\",\n    \"italic('acrAB-tolC*')\",\n    \"bold('Efflux pump')\",\n    \"italic('bla')[TEM-1]\",\n    \"bold('Penicillinases')\",\n    \"italic('bla')[SHV-1]\",\n    \"italic('bla')[OXA-1]\",\n    \"bold('Oxcillinases')\",\n    \"italic('bla')[TEM-30]\",\n    \"bold('IRT')\",\n    \"italic('bla')[TEM-10]\",\n    \"bold('ESBL')\",\n    \"italic('bla')[SHV-12]\",\n    \"italic('bla')[CTX-M-15]\",\n    \"italic('bla')[GES-3]\",\n    \"italic('bla')[VEB-1]\",\n    \"italic('bla')[ROB-1]\",\n    \"italic('bla')[TLA-1]\",\n    \"italic('ampC*')\",\n    \"bold('AmpC')\",\n    \"italic('bla')[CMY-2]\",\n    \"italic('bla')[DHA-1]\",\n    \"italic('bla')[FOX-1]\",\n    \"italic('bla')[ACC-4]\",\n    \"italic('bla')[KPC-18]\",\n    \"bold('Carbapenemases')\",\n    \"italic('bla')[OXA-48]\",\n    \"italic('bla')[NDM-1]\",\n    \"italic('bla')[IMP-4]\",\n    # Now the antibiotic subclasses in your desired order:\n    \"plain('NS penicillins')\",\n    \"plain('ES penicillins')\",\n    \"plain('Monobactams')\",\n    \"plain('1G cephalosporins')\",\n    \"plain('2G cephalosporins')\",\n    \"plain('3G cephalosporins')\",\n    \"plain('4G cephalosporins')\",\n    \"plain('Carbapenems')\"\n  ))\n)\n\nWhen calling the ggplot() function I then added the arguments label = label_pms and parse = TRUE, to parse it as plotmath syntax.\n\nps &lt;- ggplot(df_long_coloured3, aes(\n    x = x, next_x = next_x,\n    node = node, next_node = next_node,\n    fill = mechanism, label_pms = node)) +\n  geom_sankey(flow.alpha = 0.7, show.legend = FALSE) +\n  geom_sankey_text(\n    aes(label = label_pms,\n        x = stage(x, after_stat = x + 0.1 *\n          case_when(\n            x == 1 ~ -1,\n            x == 3 ~ 1,\n            .default = 0)),\n        hjust = case_when(x == \"gene\" ~ 1,\n                          x == \"subclass\" ~ 0,\n                          .default = 0.5)),\n    parse = TRUE) +\n  theme_void() +\n  scale_fill_manual(values = my_colour)\n\nps\n\n\n\n\n\n\n\n\nLastly I added a caption. For adding captions, titles and customising ggplots I would recommend Nicola Rennie’s book ’The Art of Data Visualization with ggplot2”\n\ncaption1 &lt;- \"Beta-lactam resistance in &lt;i&gt;E. coli&lt;/i&gt; predominantly occurs through the acquisition of genes encoding beta-lactamases (shades of yellow, orange, and red, according to enzyme group), but can also occur through mutations in genes encoding outer membrane proteins (light blue) or efflux pumps (dark blue); genes with mutations are marked with an asterisk. This Sankey diagram illustrates how beta-lactam resistance genes can be grouped by mechanism (reduced permeability, efflux pump and enzymatic inactivation by different beta-lactamases) and the subclasses of beta-lactams (NS - narrow spectrum and ES - extended spectrum penicllins; monobactams; 1G - first generation, 2G - second generation, 3G - third generation, 4G - fourth generation; and carbapenems) to which they confer resistance. The beta-lactamase enzymes have been grouped into penicillinases, oxacillinases, IRT (inhibitor resistant TEM), ESBL, AmpC, and carbapenemases. One representative gene variant is shown. However, resistance profiles can vary between different variants of the same enzyme and between different enzymes from the same group.\"\n\n\npsc &lt;- ps +\n  labs(caption = caption1) +\n  theme(plot.caption.position = \"plot\", \n        plot.caption = element_textbox_simple(\n          hjust = 0.5, \n          margin = margin(t = 40, r = 5, b = 5, l = 5)))\npsc\n\n\n\n\n\n\n\n\nTo attribute this work please cite:\nBurgess, Sara. 2025. “Generating and polishing Sankey diagrams in R.” 14 November, 2025. https://sburgess2.github.io/sankey_amr/"
  },
  {
    "objectID": "index.html#sankey-diagrams-to-visualise-e.-coli-resistance-genes",
    "href": "index.html#sankey-diagrams-to-visualise-e.-coli-resistance-genes",
    "title": "Resistance genes in Escherichia coli",
    "section": "",
    "text": "There are several R packages that enable Sankey diagrams to be generated. In these two examples I used the networkD3 and ggsankey packages. In this example a Sankey diagram was used to visualise the different resistance genes and mechanisms that E. coli uses to become resistant to six classes of antibiotics. A separate Sankey diagram was used to illustrate beta-lactam resistance as there are so many different beta-lactam resistance genes"
  },
  {
    "objectID": "index.html#generating-a-sankey-diagram-using-networkd3",
    "href": "index.html#generating-a-sankey-diagram-using-networkd3",
    "title": "Resistance genes in Escherichia coli",
    "section": "",
    "text": "The package networkD3 can be used for generating a variety of interactive network (as described in this geeksforgeeks blog.\n\n\nIf you haven’t done so already install the packages networkD3, tidyverse, htmlwidgets, manipulateWidget and webshot2.\nLoad the libraries\n\nlibrary(networkD3)\nlibrary(tidyverse)\nlibrary(htmlwidgets)\nlibrary(manipulateWidget)\nlibrary(webshot2)\nlibrary(paletteer)\n\n\n\n\nThe following code was adapted from the r-graph-gallery . Two data frames are needed to generate a Sankey diagram. One for the links and the other for the nodes. First read in your data for the links data frame.\n\nlinks &lt;- read_csv(\"data/resistance_mechanisms.csv\")\n\nRows: 75 Columns: 3\n── Column specification ────────────────────────────────────────────────────────\nDelimiter: \",\"\nchr (2): source, target\ndbl (1): value\n\nℹ Use `spec()` to retrieve the full column specification for this data.\nℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.\n\n\nMy csv file contains three columns: source, target, value. Source is the origin of each data link. Given, my Sankey diagram has three columns, source contains both the names of the antibiotic classes and the mechanisms. Target is the endpoint of each data link. This contains the mechanisms and resistance genes. Value is the thickness of each link.\n\n#First six lines of my data frame\nhead(links)\n\n# A tibble: 6 × 3\n  source           target                 value\n  &lt;chr&gt;            &lt;chr&gt;                  &lt;dbl&gt;\n1 Aminoglycosides  Enzymatic inactivation    14\n2 Aminoglycosides  Target alteration          8\n3 Aminoglycosides  Efflux pump                2\n4 Fluoroquinolones Enzymatic inactivation     2\n5 Fluoroquinolones Target alteration          8\n6 Fluoroquinolones Target protection          2\n\n#Last six lines of my data frame\ntail(links)\n\n# A tibble: 6 × 3\n  source      target value\n  &lt;chr&gt;       &lt;chr&gt;  &lt;dbl&gt;\n1 Efflux pump mphA       2\n2 Efflux pump mphB       2\n3 Efflux pump mefA       2\n4 Efflux pump mefB       2\n5 Efflux pump msrA       2\n6 Efflux pump msrD       2\n\n\nThe ' in some of my gene names is read in as ? so first I replaced the ? with ′.\n\nlinks$target &lt;- str_replace_all(links$target, \"\\\\?\", \"′\") \n\nNext I created a one column data frame for all the nodes. The column name is labelled name and the observations are all the unique names from source and target.\n\nnodes &lt;- data.frame(\n  name = unique(c(as.character(links$source), as.character(links$target))))\n\nA second column was added to the nodes data frame called group. This will be used to colour the Sankey diagram links by group.\n\n# Grouping\nnodes$group &lt;- case_when(\n  nodes$name == \"Aminoglycosides\" ~ \"Aminoglycosides\",\n  nodes$name == \"Fluoroquinolones\" ~ \"Fluoroquinolones\",\n  nodes$name == \"Tetracyclines\" ~ \"Tetracyclines\",\n  nodes$name == \"Phenicols\" ~ \"Phenicols\",\n  nodes$name == \"Sulfonamides & Trimethoprim\" ~ \"Sulfonamides\",\n  nodes$name == \"Nitrofurans\" ~ \"Nitrofurans\",\n  nodes$name == \"Macrolides\" ~ \"Macrolides\",\n  nodes$name %in% c(\"aac(3′)\", \"aadA\", \"aadB\", \"aadD\",\n                    \"aph(3′)\", \"aphA15\", \"rrsH*\", \"rsmG*\") ~ \"Aminoglycosides\",\n  nodes$name %in% c(\"gyrA*\", \"gyrB*\", \"parC*\", \"parE*\", \"qep\", \"qnr\", \"oqxAB\") ~ \"Fluoroquinolones\",\n  nodes$name %in% c(\"tetX\", \"tetM\", \"tetW\", \"tetA\", \"tetB\", \"tetC\", \"tetD\") ~ \"Tetracyclines\",\n  nodes$name %in% c(\"catB\", \"catII\", \"cmlA\", \"floR\") ~ \"Phenicols\",\n  nodes$name %in% c(\"dfr\", \"folP*\", \"sul1\", \"sul2\", \"sul3\", \"sul4\") ~ \"Sulfonamides\",\n  nodes$name %in% c(\"nfsA*\", \"nfsB*\", \"ahpF*\", \"ribB*\", \"ribE*\") ~ \"Nitrofurans\",\n  nodes$name %in% c(\"ermA\", \"ermB\", \"ermC\", \"ereA\", \"mphA\", \"mphB\", \"mefA\", \"mefB\", \"msrA\", \"msrD\") ~ \"Macrolides\",\n  TRUE ~ \"Other\"\n)\n\nTwo additional columns were added, which contain an index for both the source and the target. The match function is used to match the position of the values that are being matched. As I understand it networkD3 uses an index system starting from 0, whereas base R starts from 1, hence the -1 is needed to generate an index system suitable for the function networkD3::sankeyNetwork().\n\n# ID mapping\nlinks$IDsource &lt;- match(links$source, nodes$name) - 1\nlinks$IDtarget &lt;- match(links$target, nodes$name) - 1\n\nlinks\n\n# A tibble: 75 × 5\n   source           target                 value IDsource IDtarget\n   &lt;chr&gt;            &lt;chr&gt;                  &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;\n 1 Aminoglycosides  Enzymatic inactivation    14        0        7\n 2 Aminoglycosides  Target alteration          8        0        8\n 3 Aminoglycosides  Efflux pump                2        0        9\n 4 Fluoroquinolones Enzymatic inactivation     2        1        7\n 5 Fluoroquinolones Target alteration          8        1        8\n 6 Fluoroquinolones Target protection          2        1       10\n 7 Fluoroquinolones Efflux pump                6        1        9\n 8 Tetracyclines    Enzymatic inactivation     2        2        7\n 9 Tetracyclines    Target alteration          4        2        8\n10 Tetracyclines    Target protection          4        2       10\n# ℹ 65 more rows\n\n\nSimilar to the nodes data frame a group column was also added to the links data frame.\n\n#Generate vector containing the group names for all the antibiotic classes\nclass &lt;- c(\"Aminoglycosides\", \"Fluoroquinolones\", \"Tetracyclines\", \"Phenicols\", \"Sulfonamides & Trimethoprim\", \"Nitrofurans\", \"Macrolides\")\n#Generate vector containing the group names for all the mechanisms\nmechanisms &lt;- c(\"Enzymatic inactivation\", \"Target alteration\", \"Target protection\", \"Efflux pump\", \"Target replacement\", \"Reduced prodrug activation\")\n\n# Assign groups\nlinks$group &lt;- case_when(\n  links$source %in% class ~ nodes$group[match(links$source, nodes$name)],\n  links$source %in% mechanisms ~ nodes$group[match(links$target, nodes$name)],\n  TRUE ~ \"Other\")\n\nLastly I generated my colour scale. Here because networkD3 uses Javascript code the colour scale also has to be written in Javascript. '.domain' defines each group that I want to apply each colour to.\n\nmy_color &lt;- 'd3.scaleOrdinal()\n  .domain([\"Aminoglycosides\", \"Fluoroquinolones\", \"Tetracyclines\", \n           \"Phenicols\", \"Sulfonamides\", \"Nitrofurans\", \"Macrolides\", \"Other\"])\n  .range([\"#90CAF9\", \"#A5D6A7\", \"#D1C4E9\", \"#ffffb3\", \"#fb8072\", \"#fdb462\", \"#F8BBD0FF\", \"#E0E0E0\"]);'\n\n\n\n\nNow for the fun part generating the Sankey diagram.\n\n# Sankey plot\nq &lt;- sankeyNetwork(\n  Links = links, Nodes = nodes,\n  Source = \"IDsource\", Target = \"IDtarget\",\n  Value = \"value\", NodeID = \"name\",\n  NodeGroup = \"group\", LinkGroup = \"group\",\n  colourScale = my_color,\n  width = 900, height = 900,\n  nodeWidth = 60\n)\nq\n\n\n\n\n\nThere are a few things I don’t like. The font size and type, as well as having the resistance genes on top of the links.\nHere I’ve adjusted these three things within the sankeyNetwork() function using the arguments fontSize, fontFamily, and sinksRight.\n\n# Sankey plot\np &lt;- sankeyNetwork(\n  Links = links, Nodes = nodes,\n  Source = \"IDsource\", Target = \"IDtarget\",\n  Value = \"value\", NodeID = \"name\",\n  NodeGroup = \"group\", LinkGroup = \"group\",\n  colourScale = my_color,\n  fontSize = 12, fontFamily = \"Verdana\", nodeWidth = 60, sinksRight = FALSE, width = 900, height = 900\n)\np\n\n\n\n\n\nIt’s still not quite what I’d like. To my knowledge that is pretty much all that can be adjusted within the SankeyNetwork() function. However, because the Sankey diagram is an htmlwidget (you can check this using the class function) you can use the htmlwidgets package to append labels.\n\nclass(p)\n\n[1] \"sankeyNetwork\" \"htmlwidget\"   \n\n\n\n\n\nThe code below was adapted from this tutorial and the response on this stack overflow post.\nFirst I added a title to my diagram.\n\n#prepend title\np1 &lt;- htmlwidgets::prependContent(p, htmltools::tags$h1(htmltools::HTML(\"Resistance genes in &lt;em&gt;Escherichia coli&lt;/em&gt;\"),\n  style = \"text-align:center; color:#1b2422; font-size:18px; font-family:Verdana;\"))\n\nNext a footnote was added.\n\n#append footnote\np2 &lt;- htmlwidgets::appendContent(p1, htmltools::tags$p(\"* Genes with point mutations\", style = \"text-align:center; color:#666; font-size:12px; font-family:Verdana;\"))\np2\n\n\n\n* Genes with point mutations\n\n\n\nI also changed the font style to bold for the antibiotic classes and italics for the resistance genes.\n\n#The following function was generated using chapgpt\np3 &lt;- htmlwidgets::onRender(p2, '\n  function(el, x) {\n    const boldNames = [\n      \"Aminoglycosides\", \"Fluoroquinolones\", \"Tetracyclines\",\n      \"Phenicols\", \"Sulfonamides & Trimethoprim\", \"Nitrofurans\",\n      \"Enzymatic inactivation\", \"Target alteration\",\n      \"Target protection\", \"Efflux pump\", \"Target replacement\",\n      \"Reduced prodrug activation\", \"Macrolides\"\n    ];\n\n    const italicSubstrings = [\n      \"aac\", \"aad\", \"aph\", \"rr\", \"rsm\", \"qep\", \"qnr\", \"tet\", \"cat\",\n      \"gyr\", \"par\", \"mdf\", \"fol\", \"dfr\", \"nfs\", \"cml\", \"flo\", \"oqx\", \"sul\",\n      \"erm\", \"ereA\", \"mph\", \"mef\", \"msr\", \"ahpF\", \"rib\"\n    ];\n\n    d3.select(el)\n      .selectAll(\".node text\")\n      .style(\"font-weight\", d =&gt; boldNames.includes(d.name) ? \"bold\" : \"normal\")\n      .style(\"font-style\", d =&gt;\n        italicSubstrings.some(sub =&gt; d.name.includes(sub)) ? \"italic\" : \"normal\"\n      );\n  }\n')\n\np3\n\n\n\n* Genes with point mutations"
  },
  {
    "objectID": "index.html#saving-the-sankey-diagram",
    "href": "index.html#saving-the-sankey-diagram",
    "title": "Resistance genes in Escherichia coli",
    "section": "",
    "text": "If you are trying this code or similar and want to save your plot as a png you will not be able to use the ggsave() function because the Sankey diagram is an htmlwidget. First save your plot as an html and then take a screenshot using webshot.\n\nhtmlwidgets::saveWidget(p3, \"output/sankey.html\", selfcontained = TRUE)\nwebshot(\"output/sankey.html\", file = \"output/sankey_arg.png\", vwidth = 900, vheight = 900)"
  },
  {
    "objectID": "index.html#generating-a-sankey-diagram-using-ggsankey-to-visualise-e.-coli-genes-which-confer-resistance-to-the-beta-lactams.",
    "href": "index.html#generating-a-sankey-diagram-using-ggsankey-to-visualise-e.-coli-genes-which-confer-resistance-to-the-beta-lactams.",
    "title": "Resistance genes in Escherichia coli",
    "section": "Generating a Sankey diagram using ggsankey to visualise E. coli genes which confer resistance to the beta-lactams.",
    "text": "Generating a Sankey diagram using ggsankey to visualise E. coli genes which confer resistance to the beta-lactams.\nIn this example I used the package ggsankey to generate a Sankey diagram. Visualising these resistance genes was not as straight forward as the other resistance genes visualised in the network above. There are multiple enzyme types, which all have a large number of variants. Certain variants have a wider range of resistance compared with their parent types, which adds in more complexity. For this reason I started with the genes on the left hand side.\n\nPackages\nInstall the packages ggsankey, showtext and sysfonts, glue, patchwok and ggtext then load the libraries\n\n#remotes::install_github(\"davidsjoberg/ggsankey\")\n\nlibrary(ggsankey)\nlibrary(patchwork)\nlibrary(glue)\nlibrary(showtext)\nlibrary(sysfonts)\nlibrary(ggtext)\n\n\n\nRead in and prepare data\nNext I read in the data.I generated this dataset manually. The publications used for generated this dataset are listed in the bibliography.\n\ndf &lt;- read_csv(\"data/betalactams_gsankey.csv\")\n\nRows: 121 Columns: 3\n── Column specification ────────────────────────────────────────────────────────\nDelimiter: \",\"\nchr (3): gene, mechanism, subclass\n\nℹ Use `spec()` to retrieve the full column specification for this data.\nℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.\n\n\nMy csv file contains three columns: “gene”, “mechanism”, “subclass”. This data is set up differently to the first Sankey diagram in that each column will be a column in the Sankey diagram. The first column “gene” is the name of each resistance gene. The second column is the mechanism or type of enzyme. So instead of having “enzymatic inactivation” I divided the beta-lactamases into “Penicillinases”, “Oxcillinases”, “IRT” (inhibitor resistant TEM), “ESBL”, “AmpC”, and “Carbapenemases”. In addition I included the mechanisms “reduced permeability” and “efflux pump”. The third column is the antibiotic subclass. Given most genes confer resistance to multiple sub classes there are multiple rows for each gene.\n\n#Structure of my dataframe\nstr(df)\n\nspc_tbl_ [121 × 3] (S3: spec_tbl_df/tbl_df/tbl/data.frame)\n $ gene     : chr [1:121] \"ompC*\" \"ompC*\" \"ompC*\" \"ompC*\" ...\n $ mechanism: chr [1:121] \"Reduced permeability\" \"Reduced permeability\" \"Reduced permeability\" \"Reduced permeability\" ...\n $ subclass : chr [1:121] \"NS penicillins\" \"ES penicillins\" \"1G cephalosporins\" \"3G cephalosporins\" ...\n - attr(*, \"spec\")=\n  .. cols(\n  ..   gene = col_character(),\n  ..   mechanism = col_character(),\n  ..   subclass = col_character()\n  .. )\n - attr(*, \"problems\")=&lt;externalptr&gt; \n\n#First six lines of my data frame\nhead(df)\n\n# A tibble: 6 × 3\n  gene  mechanism            subclass         \n  &lt;chr&gt; &lt;chr&gt;                &lt;chr&gt;            \n1 ompC* Reduced permeability NS penicillins   \n2 ompC* Reduced permeability ES penicillins   \n3 ompC* Reduced permeability 1G cephalosporins\n4 ompC* Reduced permeability 3G cephalosporins\n5 ompC* Reduced permeability Carbapenems      \n6 ompF* Reduced permeability NS penicillins   \n\n#Last six lines of my data frame\ntail(df)\n\n# A tibble: 6 × 3\n  gene     mechanism      subclass         \n  &lt;chr&gt;    &lt;chr&gt;          &lt;chr&gt;            \n1 blaNDM-1 Carbapenemases Carbapenems      \n2 blaIMP-4 Carbapenemases 1G cephalosporins\n3 blaIMP-4 Carbapenemases 2G cephalosporins\n4 blaIMP-4 Carbapenemases 3G cephalosporins\n5 blaIMP-4 Carbapenemases 4G cephalosporins\n6 blaIMP-4 Carbapenemases Carbapenems      \n\n#The unique mechanisms / enzyme types\nunique(df$mechanism)\n\n[1] \"Reduced permeability\" \"Efflux pump\"          \"Penicillinases\"      \n[4] \"Oxcillinases\"         \"IRT\"                  \"ESBL\"                \n[7] \"AmpC\"                 \"Carbapenemases\"      \n\n#The unique subclasses of antibiotics\nunique(df$subclass)\n\n[1] \"NS penicillins\"    \"ES penicillins\"    \"1G cephalosporins\"\n[4] \"3G cephalosporins\" \"Carbapenems\"       \"4G cephalosporins\"\n[7] \"Monobactams\"       \"2G cephalosporins\"\n\n\nNext, the data was converted to a long format using a function make_long() from the ggsankey package. This long format contains columns that define how the links flow through the diagram:\n\nx: the name of the current column (called a stage) on the x axis.\nnext_x: the name of the next stage x links to (NA for the final stage which is why the subclass rows have NA values).\nnode: the value at the starting node.\nnext_node: the value at the connecting node.\n\nThe following code was adapted from https://r-graph-gallery.com/package/ggsankey.html\n\ndf_long &lt;- df %&gt;%\n        make_long(gene, mechanism, subclass)\n\nhead(df_long)\n\n# A tibble: 6 × 4\n  x         node                 next_x    next_node           \n  &lt;fct&gt;     &lt;chr&gt;                &lt;fct&gt;     &lt;chr&gt;               \n1 gene      ompC*                mechanism Reduced permeability\n2 mechanism Reduced permeability subclass  NS penicillins      \n3 subclass  NS penicillins       &lt;NA&gt;      &lt;NA&gt;                \n4 gene      ompC*                mechanism Reduced permeability\n5 mechanism Reduced permeability subclass  ES penicillins      \n6 subclass  ES penicillins       &lt;NA&gt;      &lt;NA&gt;                \n\n\nHere is a first look at how the data looks when it is plotted.\n\nggplot(df_long, aes(x = x, next_x = next_x, node = node, next_node = next_node)) +\n        geom_sankey()\n\n\n\n\n\n\n\n\nHere is the same plot with the links and nodes coloured by node.\n\nggplot(df_long, aes(x = x, next_x = next_x, node = node, next_node = next_node,\n                    fill = factor(node))) +\n        geom_sankey() +\n        scale_fill_discrete(drop = FALSE)\n\n\n\n\n\n\n\n\nThere is a lot to tidy up. First I removed the grey background, the grid, and x and y axis labels. I find that using theme_void() is the easiest way to do this. I also removed the legend using show.legend = FALSE.\n\nggplot(df_long, aes(x = x, next_x = next_x, node = node, next_node = next_node,\n                    fill = factor(node))) +\n        geom_sankey(show.legend = FALSE) +\n        scale_fill_discrete(drop = FALSE) +\n        theme_void()\n\n\n\n\n\n\n\n\nNext I addd node labels onto the Sankey diagram.\n\nggplot(df_long, aes(x = x, next_x = next_x, node = node, next_node = next_node,\n                    fill = factor(node))) +\n        geom_sankey(show.legend = FALSE) +\n        geom_sankey_text(aes(label = node)) +\n        scale_fill_discrete(drop = FALSE) +\n        theme_void()\n\n\n\n\n\n\n\n\nI wanted to change the colours of the links so that each gene would be coloured according to its mechanism using a more visually appealing colour palette (IMO) compared with the default colours. First an extra column was added to the long dataframe to group the genes and mechanism rows by mechanism.\n\nmechanism_lookup &lt;- df %&gt;%\n        select(gene, mechanism) %&gt;%\n        rename(node = gene) %&gt;%\n        bind_rows(df %&gt;% distinct(mechanism) %&gt;% rename(node = mechanism) %&gt;% mutate(mechanism = node)) %&gt;%\n        distinct()\n\n# Add mechanism info to the long data\ndf_long_coloured &lt;- df_long %&gt;%\n        left_join(mechanism_lookup, by = \"node\")\n\nhead(df_long_coloured)\n\n# A tibble: 6 × 5\n  x         node                 next_x    next_node            mechanism       \n  &lt;fct&gt;     &lt;chr&gt;                &lt;fct&gt;     &lt;chr&gt;                &lt;chr&gt;           \n1 gene      ompC*                mechanism Reduced permeability Reduced permeab…\n2 mechanism Reduced permeability subclass  NS penicillins       Reduced permeab…\n3 subclass  NS penicillins       &lt;NA&gt;      &lt;NA&gt;                 &lt;NA&gt;            \n4 gene      ompC*                mechanism Reduced permeability Reduced permeab…\n5 mechanism Reduced permeability subclass  ES penicillins       Reduced permeab…\n6 subclass  ES penicillins       &lt;NA&gt;      &lt;NA&gt;                 &lt;NA&gt;            \n\n\nI selected my colours using https://r-graph-gallery.com/color-palette-finder. Shades of blue from the seeblau palette were used for the “Reduced permeability” and “Efflux pump” mechanisms. Shades of yellow, orange, and red from the amber_material palette were used for the beta-lactamase enzyme types.\n\n#The two palettes that I selected my colours from:\npaletteer_d(\"unikn::pal_seeblau\")\n\n&lt;colors&gt;\n#CCEEF9FF #A6E1F4FF #59C7EBFF #00A9E0FF #008ECEFF \n\npaletteer_d(\"ggsci::amber_material\")\n\n&lt;colors&gt;\n#FFF8E1FF #FFECB3FF #FFE082FF #FFD54FFF #FFCA28FF #FFC107FF #FFB300FF #FFA000FF #FF8F00FF #FF6F00FF \n\n\nI defined my colour palette. All the antibiotic subclasses were defined as “other”.\n\nmy_colour &lt;- c(\n        \"Reduced permeability\" = \"#A6E1F4FF\",      \n        \"Efflux pump\" = \"#0F7BA2FF\",         \n        \"Penicillinases\" = \"#FFECB3FF\",\n        \"Oxcillinases\" = \"#FFD54FFF\", \n        \"IRT\" = \"#FFC107FF\", \n        \"ESBL\" = \"#FFA000FF\",\n        \"AmpC\" = \"#FF6F00FF\", \n        \"Carbapenemases\" = \"#DA291CFF\",\n        \"Other\" = \"#B3B7B8FF\" )\n\nI filled the links by the new mechanism variable.\n\nggplot(df_long_coloured, aes(x = x, next_x = next_x, node = node, next_node = next_node,\n                    fill = mechanism)) +\n        geom_sankey(show.legend = FALSE) +\n        geom_sankey_text(aes(label = node)) +\n        scale_fill_discrete(drop = FALSE) +\n        theme_void()\n\n\n\n\n\n\n\n\nAlthough I now have the same colour for each mechanism, my colour palette has not been used. scale_fill_discrete() was changed to scale_fill_manual(). The colours on the links were very bright so to make them slightly transparent I used the argument flow.alpha.\n\nggplot(df_long_coloured, aes(x = x, next_x = next_x, node = node, next_node = next_node,\n                    fill = mechanism)) +\n        geom_sankey(show.legend = FALSE, flow.alpha = 0.7) +\n        geom_sankey_text(aes(label = node)) +\n        scale_fill_manual(values = my_colour) +\n        theme_void()\n\n\n\n\n\n\n\n\nNext I left justified the first column labels and right justified the second column labels. This code was adapted from https://stackoverflow.com/questions/78240951/adjust-labels-on-individual-nodes-in-sankey-diagram-using-ggsankey. Here the function stage() was used to control the stage at which the aesthetics should be mapped.\n\nggplot(df_long_coloured, aes(\n        x = x, next_x = next_x,\n        node = node, next_node = next_node,\n        fill = mechanism, label = node)) +\n        geom_sankey(flow.alpha = 0.7,\n                show.legend = FALSE) +\n        geom_sankey_text(aes(\n          x = stage(x, after_stat = x + 0.1 * case_when(\n                                                  x == 1 ~ -1,    \n                                                  x == 3 ~ 1,     \n                                                  .default = 0)),\n                    hjust = case_when(x == \"gene\" ~ 1,        \n                            x == \"subclass\" ~ 0, \n                            .default = 0.5))) +\n        theme_void() +\n        scale_fill_manual(values = my_colour)\n\n\n\n\n\n\n\n\nNext I reordered the nodes. See https://github.com/davidsjoberg/ggsankey/issues/7 for more explanation on how to reorder nodes.\n\ndf_long_coloured2 &lt;- df_long_coloured\n\ndf_long_coloured2$node &lt;- factor(\n  df_long_coloured$node, \n  levels = rev(c(\n    \"ompC*\", \"Reduced permeability\", \"ompF*\", \n    \"acrAB-tolC*\", \"Efflux pump\", \n    \"blaTEM-1\", \"Penicillinases\", \"blaSHV-1\", \n    \"blaOXA-1\", \"Oxcillinases\", \n    \"blaTEM-30\", \"IRT\", \n    \"blaTEM-10\", \"ESBL\", \"blaSHV-12\", \"blaCTX-M-15\", \n    \"blaGES-3\", \"blaVEB-1\", \"blaROB-1\", \"blaTLA-1\", \n    \"ampC*\", \"AmpC\", \n    \"blaCMY-2\", \"blaDHA-1\", \"blaFOX-1\", \"blaACC-4\", \n    \"blaKPC-18\", \"Carbapenemases\", \n    \"blaOXA-48\", \"blaNDM-1\", \"blaIMP-4\",\n    \"NS penicillins\", \"ES penicillins\", \"Monobactams\", \n    \"1G cephalosporins\", \"2G cephalosporins\", \n    \"3G cephalosporins\", \"4G cephalosporins\", \"Carbapenems\"))\n)\n\ndf_long_coloured2$next_node &lt;- factor(\n  df_long_coloured$next_node, \n  levels = rev(c(\"Reduced permeability\", \"Efflux pump\", \"Penicillinases\", \n    \"Oxcillinases\", \"IRT\", \"ESBL\", \"AmpC\", \"Carbapenemases\",\n    \"NS penicillins\", \"ES penicillins\",\"Monobactams\",\"1G cephalosporins\",\n    \"Carbapenems\",\"2G cephalosporins\",\"3G cephalosporins\", \"4G cephalosporins\"))\n)\n\nThe plot with the reordered nodes.\n\nggplot(df_long_coloured2, aes(\n        x = x, next_x = next_x,\n        node = node, next_node = next_node,\n        fill = mechanism, label = node)) +\n        geom_sankey(flow.alpha = 0.7,\n                show.legend = FALSE) +\n        geom_sankey_text(aes(\n          x = stage(x, after_stat = x + 0.1 *case_when(\n                                                  x == 1 ~ -1,    \n                                                  x == 3 ~ 1,     \n                                                  .default = 0)),\n                    hjust = case_when(x == \"gene\" ~ 1,        \n                            x == \"subclass\" ~ 0, \n                            .default = 0.5))) +\n        theme_void() +\n        scale_fill_manual(values = my_colour)\n\n\n\n\n\n\n\n\nI italicised the gene names and changed the mechanisms to a bold style using plotmath syntax (if you know of other ways to do this please let me know). First I added another column, which will be used for plotmath syntax, called label_pms. For example to generate x in italic font is written as italic(x). To see more on plotmath syntax see this link https://www.rdocumentation.org/packages/grDevices/versions/3.6.2/topics/plotmath. The paste() function was used to join strings together with no separator. I joined either the string \"italic('\", \"bold('\", or \"plain('\" with the node value (so the gene name), and the string \"')\". Then I changed those labels with a bla gene so that the enzyme type was written in subscript. The function str_replace_all() was used to replace any text with the literal string italic\\\\( followed by bla with the pattern of three word characters\\\\w{3}, a literal hyphen -, one word character \\\\w followed by one or more digits \\\\d or (|) the pattern of three word characters, hyphen, multiple digits.\n\n#Add a new column called label_pms with the plotmath syntax for font styling\ndf_long_coloured3 &lt;- df_long_coloured2 %&gt;%\n  mutate(label_pms = case_when(\n    x == \"gene\" ~ paste0(\"italic('\", node, \"')\"),          \n    x == \"mechanism\" ~ paste0(\"bold('\", node, \"')\"),       \n    x == \"subclass\" ~ paste0(\"plain('\", node, \"')\")        \n  ))\n\n#Change the bla gene labels to subscript after bla\ndf_long_coloured3 &lt;- df_long_coloured3 %&gt;%\n  mutate(label_pms = str_replace_all(label_pms,                                \"italic\\\\('(bla)(\\\\w{3}-\\\\w-\\\\d+|\\\\w{3}-\\\\d+)'\\\\)\", \n                               \"italic('\\\\1')[\\\\2]\"))\n\nNote that when you change the order of your nodes, you also need to set the levels for your labels so that they match the same order as your nodes.\n\ndf_long_coloured3$label_pms &lt;- factor(\n  df_long_coloured3$label_pms,\n  levels = rev(c(\n    \"italic('ompC*')\",\n    \"bold('Reduced permeability')\",\n    \"italic('ompF*')\",\n    \"italic('acrAB-tolC*')\",\n    \"bold('Efflux pump')\",\n    \"italic('bla')[TEM-1]\",\n    \"bold('Penicillinases')\",\n    \"italic('bla')[SHV-1]\",\n    \"italic('bla')[OXA-1]\",\n    \"bold('Oxcillinases')\",\n    \"italic('bla')[TEM-30]\",\n    \"bold('IRT')\",\n    \"italic('bla')[TEM-10]\",\n    \"bold('ESBL')\",\n    \"italic('bla')[SHV-12]\",\n    \"italic('bla')[CTX-M-15]\",\n    \"italic('bla')[GES-3]\",\n    \"italic('bla')[VEB-1]\",\n    \"italic('bla')[ROB-1]\",\n    \"italic('bla')[TLA-1]\",\n    \"italic('ampC*')\",\n    \"bold('AmpC')\",\n    \"italic('bla')[CMY-2]\",\n    \"italic('bla')[DHA-1]\",\n    \"italic('bla')[FOX-1]\",\n    \"italic('bla')[ACC-4]\",\n    \"italic('bla')[KPC-18]\",\n    \"bold('Carbapenemases')\",\n    \"italic('bla')[OXA-48]\",\n    \"italic('bla')[NDM-1]\",\n    \"italic('bla')[IMP-4]\",\n    # Now the antibiotic subclasses in your desired order:\n    \"plain('NS penicillins')\",\n    \"plain('ES penicillins')\",\n    \"plain('Monobactams')\",\n    \"plain('1G cephalosporins')\",\n    \"plain('2G cephalosporins')\",\n    \"plain('3G cephalosporins')\",\n    \"plain('4G cephalosporins')\",\n    \"plain('Carbapenems')\"\n  ))\n)\n\nWhen calling the ggplot() function I then added the arguments label = label_pms and parse = TRUE, to parse it as plotmath syntax.\n\nps &lt;- ggplot(df_long_coloured3, aes(\n    x = x, next_x = next_x,\n    node = node, next_node = next_node,\n    fill = mechanism, label_pms = node)) +\n  geom_sankey(flow.alpha = 0.7, show.legend = FALSE) +\n  geom_sankey_text(\n    aes(label = label_pms,\n        x = stage(x, after_stat = x + 0.1 *\n          case_when(\n            x == 1 ~ -1,\n            x == 3 ~ 1,\n            .default = 0)),\n        hjust = case_when(x == \"gene\" ~ 1,\n                          x == \"subclass\" ~ 0,\n                          .default = 0.5)),\n    parse = TRUE) +\n  theme_void() +\n  scale_fill_manual(values = my_colour)\n\nps\n\n\n\n\n\n\n\n\nLastly I added a caption.\n\ncaption1 &lt;- \"Beta-lactam resistance in &lt;i&gt;E. coli&lt;/i&gt; predominantly occurs through the acquisition of genes encoding beta-lactamases (shades of yellow, orange, and red, according to enzyme group), but can also occur through mutations in genes encoding outer membrane proteins (light blue) or efflux pumps (dark blue); genes with mutations are marked with an asterisk. This Sankey diagram illustrates how beta-lactam resistance genes can be grouped by mechanism (reduced permeability, efflux pump and enzymatic inactivation by different beta-lactamases) and the subclasses of beta-lactams (NS - narrow spectrum and ES - extended spectrum penicllins; monobactams; 1G - first generation, 2G - second generation, 3G - third generation, 4G - fourth generation; and carbapenems) to which they confer resistance. The beta-lactamase enzymes have been grouped into penicillinases, oxacillinases, IRT (inhibitor resistant TEM), ESBL, AmpC, and carbapenemases. One representative gene variant is shown. However, resistance profiles can vary between different variants of the same enzyme and between different enzymes from the same group.\"\n\n\npsc &lt;- ps +\n  labs(caption = caption1) +\n  theme(plot.caption.position = \"plot\", \n        plot.caption = element_textbox_simple(\n          hjust = 0.5, \n          margin = margin(t = 40, r = 5, b = 5, l = 5)))\npsc\n\n\n\n\n\n\n\n#ggsave(\"output/ggsankey_final.png\", plot = psc, width = 12, height = 0.67 * 12, dpi = 300)\n\nBeta-lactamase enzymes can be grouped by Ambler class (based on the amino acid sequence) or the Bush functional group (based on substrate and inhibitor activity). I’d like people to use the Sankey diagram as a reference, so I thought it would be useful to also add in a heat map to identify the Ambler class and Bush functional group of each enzyme. This will be attached to the Sankey diagram.\n\ncg &lt;- read_csv(\"data/class_group.csv\")\n\nRows: 19 Columns: 4\n── Column specification ────────────────────────────────────────────────────────\nDelimiter: \",\"\nchr (4): Gene, Enzyme, Ambler class, Functional group\n\nℹ Use `spec()` to retrieve the full column specification for this data.\nℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.\n\ncg_long &lt;- cg %&gt;%\n        pivot_longer(cols = c(\"Ambler class\", \"Functional group\"),\n                     names_to = \"Category\", values_to = \"Value\")\n\ncg_long2 &lt;- cg_long\n\ncg_long2$Enzyme &lt;- factor(\n  cg_long2$Enzyme,\n  levels = rev(c(\"TEM-1\", \"SHV-1\", \"OXA-1\", \"TEM-30\", \"TEM-10\", \"SHV-12\", \"CTX-M-15\", \"GES-3\", \"ROB-1\", \"TLA-1\", \"AmpC\", \"CMY-2\", \"DHA-1\", \"FOX-1\", \"ACC-4\", \"KPC-18\", \"OXA-48\", \"NDM-1\", \"IMP-4\")))\n\nggplot(data = cg_long2, aes(x = Category, y = Enzyme, fill = Value)) +\n        geom_tile(color = \"white\", show.legend = FALSE) +\n        geom_text(aes(label = Value), color = \"white\", size = 4) +      \n        coord_equal() +\n        scale_fill_paletteer_d(\"impressionist.colors::la_recolte_des_foins_eragny\") +\n        scale_x_discrete(position = \"top\", labels = label_wrap_gen(10)) +\n        theme_minimal() +\n        theme(axis.title = element_blank(),\n                axis.text.y = element_text(size = 8),\n\n                              panel.grid = element_blank()) \n\n\n\n\n\n\n\n\nThe column widths were too narrow to fit the values and the axis title. So I removed coord_equal(), which makes the the length and the width the same for each tile. Instead I used coord_fixed() to set the ratio.\n\nph &lt;- ggplot(data = cg_long2, aes(x = Category, y = Enzyme, fill = Value)) +\n        geom_tile(color = \"white\", show.legend = FALSE) +\n        geom_text(aes(label = Value), color = \"white\", size = 4) +      \n        scale_fill_paletteer_d(\"impressionist.colors::la_recolte_des_foins_eragny\") +\n        scale_x_discrete(position = \"top\", labels = label_wrap_gen(10)) +\n        coord_fixed(ratio = 0.3) +\n        theme_minimal(base_size = 6) +\n        theme(axis.title = element_blank(),\n                axis.text.y = element_text(size = 8),\n              panel.grid = element_blank()) \n\nph\n\n\n\n\n\n\n\n\nI also generated a caption for this plot\n\ncaption2 &lt;- \"Beta-lactamases can be grouped according to their Ambler class and Bush functional group. Ambler classes are based on amino acid sequence similarity (doi: 10.1042/bj2760269), and Bush functional groups are based on substrate and inhibitor profiles (doi:10.1128/AAC.01009-09).\"\n\nphc &lt;- ph + labs(caption = caption2) +\n  theme(plot.caption.position = \"plot\", \n        plot.caption = element_textbox_simple(\n          lineheight = 0.5,\n          hjust = 0,\n          margin = margin(t = 50, r = 10, b = 5, l = 10)))\n        #plot.margin = margin(t = 5, r = 10, b = 40, l = 10))\n\n#ggsave(\"output/heatmap_final.png\", plot = phc, width = 12, height = 0.67 * 12, dpi = 300)\n\nI joined the Sankey diagram and the heatmap together using the patchwork library\n\np_join &lt;- phc + psc\n\nNext I added the title and subtitle. For adding titles and customising ggplots I would recommend Nicola Rennie’s book ’The Art of Data Visualization with ggplot2”\n\ntitle &lt;- \"Beta-lactam resistance in &lt;i&gt;Escherichia coli&lt;/i&gt;\"\n\nFinally I added my social media and business icons. This code was adapted from Rennie, Nicola. 2023. “Adding Social Media Icons to Charts with {Ggplot2}.” July 27, 2023. https://nrennie.rbind.io/blog/adding-social-media-icons-ggplot2/.\n\nsysfonts::font_add_google(name = \"Baloo 2\", family = \"baloo\")\nsysfonts::font_add(\n  family = \"Font Awesome 7 Brands\",\n  regular = \"fonts/fontawesome-free-7.1.0/otfs/Font-Awesome-7-Brands-Regular-400.otf\"\n)\nshowtext_auto()  # Only need this ONCE, after all fonts are added\nshowtext_opts(dpi = 300)\n\nbrand_font &lt;- \"baloo\"\nbrand_color &lt;- \"#55692f\"\n\ngithub_icon &lt;- \"&#xf09b\"\ngithub_username &lt;- \"sburgess2\"\nlinkedin_icon &lt;- \"&#xf08c\"\nlinkedin_username &lt;- \"sara-burgess\"\n\n#img = image, src = source, span is a span tag for inline styling\nsocial_caption &lt;- glue(\n  \"&lt;img src='logo/GreenhoodLogoMark.png' width='20' height='14.84'/&gt; &lt;span style='color: {brand_color};'&gt;&lt;strong&gt; Sara Burgess&lt;/strong&gt;&lt;/span&gt; |\",\n  \"&lt;span style='font-family:\\\"Font Awesome 7 Brands\\\";'&gt;{github_icon};&lt;/span&gt; \",\n  \"&lt;span style='color: #000000'&gt;{github_username}&lt;/span&gt; | \",\n  \"&lt;span style='font-family:\\\"Font Awesome 7 Brands\\\";'&gt;{linkedin_icon};&lt;/span&gt; \",\n  \"&lt;span style='color: #000000'&gt;{linkedin_username}&lt;/span&gt;\"\n)\n\nThis is what my caption looks like without the plot. As described in Nicole Rennie’s blog the element_text_box_simple() function is added so it can enable Markdown and/or HTML code. The element_text_box() function is very similar but it does not have any default values.\n\nggplot() +\n  labs(caption = social_caption, title = title) +\n  theme(plot.caption = element_textbox_simple(),\n        plot.title = element_textbox_simple())\n\n\n\n\n\n\n\n\nNext I added my caption to the plot. I have used plot_annotation() to add the caption because, I’m using the library patchwork to join the two plots together.\n\n#Note this results in a caption twice under each plot\np_final &lt;- p_join +\n  plot_annotation(caption = social_caption, title = title) &\n  theme(\n    plot.caption = element_textbox_simple(\n  margin = margin(t = 30, r = 10, b = 20, l = 5),\n  size = 8),\n    plot.title = element_textbox_simple(),\n    base_size = 6)\n\np_final\n\n\n\n\n\n\n\n#ggsave(\"output/hm_ggsankey_final.png\", plot = p_final, width = 12, height = 0.67 * 12, dpi = 300)"
  },
  {
    "objectID": "sankey_amr.html",
    "href": "sankey_amr.html",
    "title": "Resistance genes in Escherichia coli",
    "section": "",
    "text": "There are several R packages that enable Sankey diagrams to be generated. In these two examples I used the networkD3 and ggsankey packages. In this example a Sankey diagram was used to visualise the different resistance genes and mechanisms that E. coli uses to become resistant to six classes of antibiotics. A separate Sankey diagram was used to illustrate beta-lactam resistance as there are so many different beta-lactam resistance genes"
  },
  {
    "objectID": "sankey_amr.html#sankey-diagrams-to-visualise-e.-coli-resistance-genes",
    "href": "sankey_amr.html#sankey-diagrams-to-visualise-e.-coli-resistance-genes",
    "title": "Resistance genes in Escherichia coli",
    "section": "",
    "text": "There are several R packages that enable Sankey diagrams to be generated. In these two examples I used the networkD3 and ggsankey packages. In this example a Sankey diagram was used to visualise the different resistance genes and mechanisms that E. coli uses to become resistant to six classes of antibiotics. A separate Sankey diagram was used to illustrate beta-lactam resistance as there are so many different beta-lactam resistance genes"
  },
  {
    "objectID": "sankey_amr.html#generating-a-sankey-diagram-using-networkd3",
    "href": "sankey_amr.html#generating-a-sankey-diagram-using-networkd3",
    "title": "Resistance genes in Escherichia coli",
    "section": "Generating a Sankey diagram using networkD3",
    "text": "Generating a Sankey diagram using networkD3\nThis Sankey diagram covers E. coli resistance to six classes of antibiotics (Aminoglycosides, Fluoroquinolones, Tetracyclines, Phenicols, Sulfonamides & Trimethoprim, “Nitrofurans).\n\nPackages\nIf you haven’t done so already install the packages networkD3, tidyverse, htmlwidgets, manipulateWidget and webshot2.\nLoad the libraries\n\nlibrary(networkD3)\nlibrary(tidyverse)\nlibrary(htmlwidgets)\nlibrary(manipulateWidget)\nlibrary(webshot2)\nlibrary(paletteer)\n\n\n\nRead in and prepare data\nThe following code was adapted from https://r-graph-gallery.com/321-introduction-to-interactive-sankey-diagram-2.html (and a little bit of help from ChatGPT when I had trouble setting up the groups). Two data frames are needed to generate a Sankey diagram. One for the links and the other for the nodes. In the R Graph Gallery example, the links data frame was generated using the data.frame() function. Initially I tried this, but then it became too messy when I was adding multiple antibiotic classes so I read in a csv file.\n\nlinks &lt;- read_csv(\"data/resistance_mechanisms.csv\")\n\nRows: 75 Columns: 3\n── Column specification ────────────────────────────────────────────────────────\nDelimiter: \",\"\nchr (2): source, target\ndbl (1): value\n\nℹ Use `spec()` to retrieve the full column specification for this data.\nℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.\n\n\nMy csv file contains three columns: source, target, value. Source is the origin of each data link. Given, my Sankey diagram has three columns, source is both the name of the of the antibiotic classes and the mechanisms. Target is the endpoint of each data link. This contains the mechanisms and resistance genes. Value is the thickness of each link.\n\n#First six lines of my data frame\nhead(links)\n\n# A tibble: 6 × 3\n  source           target                 value\n  &lt;chr&gt;            &lt;chr&gt;                  &lt;dbl&gt;\n1 Aminoglycosides  Enzymatic inactivation    14\n2 Aminoglycosides  Target alteration          8\n3 Aminoglycosides  Efflux pump                2\n4 Fluoroquinolones Enzymatic inactivation     2\n5 Fluoroquinolones Target alteration          8\n6 Fluoroquinolones Target protection          2\n\n#Last six lines of my data frame\ntail(links)\n\n# A tibble: 6 × 3\n  source      target value\n  &lt;chr&gt;       &lt;chr&gt;  &lt;dbl&gt;\n1 Efflux pump mphA       2\n2 Efflux pump mphB       2\n3 Efflux pump mefA       2\n4 Efflux pump mefB       2\n5 Efflux pump msrA       2\n6 Efflux pump msrD       2\n\n\nThe ` in some of my gene names is read in as ? so first I replaced the ? with ′\n\nlinks$target &lt;- str_replace_all(links$target, \"\\\\?\", \"′\") \n\nNext I created a one column data frame for all the nodes. The column name is labelled name and the observations are all the unique names from source and target.\n\nnodes &lt;- data.frame(\n  name = unique(c(as.character(links$source), as.character(links$target))))\n\nA second column was added to the nodes data frame called group. This will be used to colour the Sankey diagram links by group.\n\n# Grouping\nnodes$group &lt;- case_when(\n  nodes$name == \"Aminoglycosides\" ~ \"Aminoglycosides\",\n  nodes$name == \"Fluoroquinolones\" ~ \"Fluoroquinolones\",\n  nodes$name == \"Tetracyclines\" ~ \"Tetracyclines\",\n  nodes$name == \"Phenicols\" ~ \"Phenicols\",\n  nodes$name == \"Sulfonamides & Trimethoprim\" ~ \"Sulfonamides\",\n  nodes$name == \"Nitrofurans\" ~ \"Nitrofurans\",\n  nodes$name == \"Macrolides\" ~ \"Macrolides\",\n  nodes$name %in% c(\"aac(3′)\", \"aadA\", \"aadB\", \"aadD\",\n                    \"aph(3′)\", \"aphA15\", \"rrsH*\", \"rsmG*\") ~ \"Aminoglycosides\",\n  nodes$name %in% c(\"gyrA*\", \"gyrB*\", \"parC*\", \"parE*\", \"qep\", \"qnr\", \"oqxAB\") ~ \"Fluoroquinolones\",\n  nodes$name %in% c(\"tetX\", \"tetM\", \"tetW\", \"tetA\", \"tetB\", \"tetC\", \"tetD\") ~ \"Tetracyclines\",\n  nodes$name %in% c(\"catB\", \"catII\", \"cmlA\", \"floR\") ~ \"Phenicols\",\n  nodes$name %in% c(\"dfr\", \"folP*\", \"sul1\", \"sul2\", \"sul3\", \"sul4\") ~ \"Sulfonamides\",\n  nodes$name %in% c(\"nfsA*\", \"nfsB*\", \"ahpF*\", \"ribB*\", \"ribE*\") ~ \"Nitrofurans\",\n  nodes$name %in% c(\"ermA\", \"ermB\", \"ermC\", \"ereA\", \"mphA\", \"mphB\", \"mefA\", \"mefB\", \"msrA\", \"msrD\") ~ \"Macrolides\",\n  TRUE ~ \"Other\"\n)\n\nTwo additional columns were added, which contain an index for both the source and the target. The match function is used to match the position of the values that are being matched. As I understand it networkD3 uses an index system starting from 0, whereas base R starts from 1, hence the -1 is needed to generate an index system suitable for the function networkD3::sankeyNetwork().\n\n# ID mapping\nlinks$IDsource &lt;- match(links$source, nodes$name) - 1\nlinks$IDtarget &lt;- match(links$target, nodes$name) - 1\n\nlinks\n\n# A tibble: 75 × 5\n   source           target                 value IDsource IDtarget\n   &lt;chr&gt;            &lt;chr&gt;                  &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;\n 1 Aminoglycosides  Enzymatic inactivation    14        0        7\n 2 Aminoglycosides  Target alteration          8        0        8\n 3 Aminoglycosides  Efflux pump                2        0        9\n 4 Fluoroquinolones Enzymatic inactivation     2        1        7\n 5 Fluoroquinolones Target alteration          8        1        8\n 6 Fluoroquinolones Target protection          2        1       10\n 7 Fluoroquinolones Efflux pump                6        1        9\n 8 Tetracyclines    Enzymatic inactivation     2        2        7\n 9 Tetracyclines    Target alteration          4        2        8\n10 Tetracyclines    Target protection          4        2       10\n# ℹ 65 more rows\n\n\nSimilar to the nodes data frame a group column was also added to the links data frame.\n\n#Generate vector containing the group names for all the antibiotic classes\nclass &lt;- c(\"Aminoglycosides\", \"Fluoroquinolones\", \"Tetracyclines\", \"Phenicols\", \"Sulfonamides & Trimethoprim\", \"Nitrofurans\", \"Macrolides\")\n#Generate vector containing the group names for all the mechanisms\nmechanisms &lt;- c(\"Enzymatic inactivation\", \"Target alteration\", \"Target protection\", \"Efflux pump\", \"Target replacement\", \"Reduced prodrug activation\")\n\n# Assign groups\nlinks$group &lt;- case_when(\n  links$source %in% class ~ nodes$group[match(links$source, nodes$name)],\n  links$source %in% mechanisms ~ nodes$group[match(links$target, nodes$name)],\n  TRUE ~ \"Other\")\n\nLastly I generated my colour scale. Here (as I understand it) because networkD3 uses Javascript code the colour scale also has to be written in Javascript. ‘.domain’ defines each group that I want to apply each colour to.\n\nmy_color &lt;- 'd3.scaleOrdinal()\n  .domain([\"Aminoglycosides\", \"Fluoroquinolones\", \"Tetracyclines\", \n           \"Phenicols\", \"Sulfonamides\", \"Nitrofurans\", \"Macrolides\", \"Other\"])\n  .range([\"#90CAF9\", \"#A5D6A7\", \"#D1C4E9\", \"#ffffb3\", \"#fb8072\", \"#fdb462\", \"#F8BBD0FF\", \"#E0E0E0\"]);'\n\n\n\nSankey diagram\nNow for the fun part generating the Sankey diagram.\n\n# Sankey plot\nq &lt;- sankeyNetwork(\n  Links = links, Nodes = nodes,\n  Source = \"IDsource\", Target = \"IDtarget\",\n  Value = \"value\", NodeID = \"name\",\n  NodeGroup = \"group\", LinkGroup = \"group\",\n  colourScale = my_color,\n  width = 900, height = 900,\n  nodeWidth = 60\n)\nq\n\n\n\n\n\nThere are a few things I don’t like. The font size and type, as well as having the resistance genes on top of the links.\nHere I’ve adjusted these three things within the sankeyNetwork() function using the arguments fontSize, fontFamily, and sinksRight.\n\n# Sankey plot\np &lt;- sankeyNetwork(\n  Links = links, Nodes = nodes,\n  Source = \"IDsource\", Target = \"IDtarget\",\n  Value = \"value\", NodeID = \"name\",\n  NodeGroup = \"group\", LinkGroup = \"group\",\n  colourScale = my_color,\n  fontSize = 12, fontFamily = \"Verdana\", nodeWidth = 60, sinksRight = FALSE, width = 900, height = 900\n)\np\n\n\n\n\n\nIt’s still not quite what I’d like. To my knowledge that is pretty much all that can be adjusted within the SankeyNetwork() function. However, because the Sankey Network is an htmlwidget (you can check this using the class function) you can use the htmlwidge package to append labels.\n\nclass(p)\n\n[1] \"sankeyNetwork\" \"htmlwidget\"   \n\n\n\n\nUsing htmlwidgets to adjust the Sankey diagram\nThe code below was adapted from the tutorial https://www.geeksforgeeks.org/r-language/how-to-add-axis-labels-using-networkd3-in-r/ and the response on this stack overflow post https://stackoverflow.com/questions/50132459/how-to-add-title-to-a-networkd3-visualisation-when-saving-as-a-web-page\nHere I’ve added a title to my diagram.\n\n#prepend title\np1 &lt;- htmlwidgets::prependContent(p, htmltools::tags$h1(htmltools::HTML(\"Resistance genes in &lt;em&gt;Escherichia coli&lt;/em&gt;\"),\n  style = \"text-align:center; color:#1b2422; font-size:18px; font-family:Verdana;\"))\np1\n\n\n\n\n\n\nHere I’ve added a footnote to my diagram.\n\n#append footnote\np2 &lt;- htmlwidgets::appendContent(p1, htmltools::tags$p(\"* Genes with point mutations\", style = \"text-align:center; color:#666; font-size:12px; font-family:Verdana;\"))\np2\n\nResistance genes in Escherichia coli\n\n* Genes with point mutations\n\n\n\nI also wanted to change the font style to bold for the antibiotic classes and italics for the resistance genes. I got a bit of help from ChatGPT for this piece of code.\n\n#The following function was generated using chapgpt\np3 &lt;- htmlwidgets::onRender(p2, '\n  function(el, x) {\n    const boldNames = [\n      \"Aminoglycosides\", \"Fluoroquinolones\", \"Tetracyclines\",\n      \"Phenicols\", \"Sulfonamides & Trimethoprim\", \"Nitrofurans\",\n      \"Enzymatic inactivation\", \"Target alteration\",\n      \"Target protection\", \"Efflux pump\", \"Target replacement\",\n      \"Reduced prodrug activation\", \"Macrolides\"\n    ];\n\n    const italicSubstrings = [\n      \"aac\", \"aad\", \"aph\", \"rr\", \"rsm\", \"qep\", \"qnr\", \"tet\", \"cat\",\n      \"gyr\", \"par\", \"mdf\", \"fol\", \"dfr\", \"nfs\", \"cml\", \"flo\", \"oqx\", \"sul\",\n      \"erm\", \"ereA\", \"mph\", \"mef\", \"msr\", \"ahpF\", \"rib\"\n    ];\n\n    d3.select(el)\n      .selectAll(\".node text\")\n      .style(\"font-weight\", d =&gt; boldNames.includes(d.name) ? \"bold\" : \"normal\")\n      .style(\"font-style\", d =&gt;\n        italicSubstrings.some(sub =&gt; d.name.includes(sub)) ? \"italic\" : \"normal\"\n      );\n  }\n')\n\np3\n\nResistance genes in Escherichia coli\n\n* Genes with point mutations"
  },
  {
    "objectID": "sankey_amr.html#saving-the-sankey-diagram",
    "href": "sankey_amr.html#saving-the-sankey-diagram",
    "title": "Resistance genes in Escherichia coli",
    "section": "Saving the Sankey diagram",
    "text": "Saving the Sankey diagram\nIf you are trying this code or similar and want to save your plot as a png you will not be able to use ggsave() function because the Sankey Network is an htmlwidget. First save your plot as an html and then take a screenshot using webshot.\n\nhtmlwidgets::saveWidget(p3, \"output/sankey.html\", selfcontained = TRUE)\nwebshot(\"output/sankey.html\", file = \"output/sankey_arg.png\", vwidth = 900, vheight = 900)\n\nOne thing I haven’t been able to work out is how remove the white space on either side and align the footer to the gene name column, when I save the plot as a png. When I tried to use style = “text-align:right” the footnote disappeared off the page in the png. If anyone reading this has any tips please email me or DM on LinkedIn.\nLastly here are some references I used for generating the resistance gene list:\nmounsey2024?"
  },
  {
    "objectID": "sankey_amr.html#generating-a-sankey-diagram-using-ggsankey-to-visualise-e.-coli-genes-which-confer-resistance-to-the-beta-lactams.",
    "href": "sankey_amr.html#generating-a-sankey-diagram-using-ggsankey-to-visualise-e.-coli-genes-which-confer-resistance-to-the-beta-lactams.",
    "title": "Resistance genes in Escherichia coli",
    "section": "Generating a Sankey diagram using ggsankey to visualise E. coli genes which confer resistance to the beta-lactams.",
    "text": "Generating a Sankey diagram using ggsankey to visualise E. coli genes which confer resistance to the beta-lactams.\nIn this example I used the package ggsankey to generate a Sankey diagram. Visualising these resistance genes was not as straight forward as the other resistance genes visualised in the network above. There are multiple enzyme types, which all have a large number of variants. Certain variants have a wider range of resistance compared with their parent types, which adds in more complexity. For this reason I started with the genes on the left hand side.\n\nPackages\nInstall the packages ggsankey, showtext and sysfonts, glue, patchwok and ggtext then load the libraries\n\n#remotes::install_github(\"davidsjoberg/ggsankey\")\n\nlibrary(ggsankey)\nlibrary(patchwork)\nlibrary(glue)\nlibrary(showtext)\nlibrary(sysfonts)\nlibrary(ggtext)\n\n\n\nRead in and prepare data\nNext I read in the data.I generated this dataset manually. The publications used for generated this dataset are listed in the bibliography.\n\ndf &lt;- read_csv(\"data/betalactams_gsankey.csv\")\n\nRows: 121 Columns: 3\n── Column specification ────────────────────────────────────────────────────────\nDelimiter: \",\"\nchr (3): gene, mechanism, subclass\n\nℹ Use `spec()` to retrieve the full column specification for this data.\nℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.\n\n\nMy csv file contains three columns: “gene”, “mechanism”, “subclass”. This data is set up differently to the first Sankey diagram in that each column will be a column in the Sankey diagram. The first column “gene” is the name of each resistance gene. The second column is the mechanism or type of enzyme. So instead of having “enzymatic inactivation” I divided the beta-lactamases into “Penicillinases”, “Oxcillinases”, “IRT” (inhibitor resistant TEM), “ESBL”, “AmpC”, and “Carbapenemases”. In addition I included the mechanisms “reduced permeability” and “efflux pump”. The third column is the antibiotic subclass. Given most genes confer resistance to multiple sub classes there are multiple rows for each gene.\n\n#Structure of my dataframe\nstr(df)\n\nspc_tbl_ [121 × 3] (S3: spec_tbl_df/tbl_df/tbl/data.frame)\n $ gene     : chr [1:121] \"ompC*\" \"ompC*\" \"ompC*\" \"ompC*\" ...\n $ mechanism: chr [1:121] \"Reduced permeability\" \"Reduced permeability\" \"Reduced permeability\" \"Reduced permeability\" ...\n $ subclass : chr [1:121] \"NS penicillins\" \"ES penicillins\" \"1G cephalosporins\" \"3G cephalosporins\" ...\n - attr(*, \"spec\")=\n  .. cols(\n  ..   gene = col_character(),\n  ..   mechanism = col_character(),\n  ..   subclass = col_character()\n  .. )\n - attr(*, \"problems\")=&lt;externalptr&gt; \n\n#First six lines of my data frame\nhead(df)\n\n# A tibble: 6 × 3\n  gene  mechanism            subclass         \n  &lt;chr&gt; &lt;chr&gt;                &lt;chr&gt;            \n1 ompC* Reduced permeability NS penicillins   \n2 ompC* Reduced permeability ES penicillins   \n3 ompC* Reduced permeability 1G cephalosporins\n4 ompC* Reduced permeability 3G cephalosporins\n5 ompC* Reduced permeability Carbapenems      \n6 ompF* Reduced permeability NS penicillins   \n\n#Last six lines of my data frame\ntail(df)\n\n# A tibble: 6 × 3\n  gene     mechanism      subclass         \n  &lt;chr&gt;    &lt;chr&gt;          &lt;chr&gt;            \n1 blaNDM-1 Carbapenemases Carbapenems      \n2 blaIMP-4 Carbapenemases 1G cephalosporins\n3 blaIMP-4 Carbapenemases 2G cephalosporins\n4 blaIMP-4 Carbapenemases 3G cephalosporins\n5 blaIMP-4 Carbapenemases 4G cephalosporins\n6 blaIMP-4 Carbapenemases Carbapenems      \n\n#The unique mechanisms / enzyme types\nunique(df$mechanism)\n\n[1] \"Reduced permeability\" \"Efflux pump\"          \"Penicillinases\"      \n[4] \"Oxcillinases\"         \"IRT\"                  \"ESBL\"                \n[7] \"AmpC\"                 \"Carbapenemases\"      \n\n#The unique subclasses of antibiotics\nunique(df$subclass)\n\n[1] \"NS penicillins\"    \"ES penicillins\"    \"1G cephalosporins\"\n[4] \"3G cephalosporins\" \"Carbapenems\"       \"4G cephalosporins\"\n[7] \"Monobactams\"       \"2G cephalosporins\"\n\n\nNext, the data was converted to a long format using a function make_long() from the ggsankey package. This long format contains columns that define how the links flow through the diagram:\n\nx: the name of the current column (called a stage) on the x axis.\nnext_x: the name of the next stage x links to (NA for the final stage which is why the subclass rows have NA values).\nnode: the value at the starting node.\nnext_node: the value at the connecting node.\n\nThe following code was adapted from https://r-graph-gallery.com/package/ggsankey.html\n\ndf_long &lt;- df %&gt;%\n        make_long(gene, mechanism, subclass)\n\nhead(df_long)\n\n# A tibble: 6 × 4\n  x         node                 next_x    next_node           \n  &lt;fct&gt;     &lt;chr&gt;                &lt;fct&gt;     &lt;chr&gt;               \n1 gene      ompC*                mechanism Reduced permeability\n2 mechanism Reduced permeability subclass  NS penicillins      \n3 subclass  NS penicillins       &lt;NA&gt;      &lt;NA&gt;                \n4 gene      ompC*                mechanism Reduced permeability\n5 mechanism Reduced permeability subclass  ES penicillins      \n6 subclass  ES penicillins       &lt;NA&gt;      &lt;NA&gt;                \n\n\nHere is a first look at how the data looks when it is plotted.\n\nggplot(df_long, aes(x = x, next_x = next_x, node = node, next_node = next_node)) +\n        geom_sankey()\n\n\n\n\n\n\n\n\nHere is the same plot with the links and nodes coloured by node.\n\nggplot(df_long, aes(x = x, next_x = next_x, node = node, next_node = next_node,\n                    fill = factor(node))) +\n        geom_sankey() +\n        scale_fill_discrete(drop = FALSE)\n\n\n\n\n\n\n\n\nThere is a lot to tidy up. First I removed the grey background, the grid, and x and y axis labels. I find that using theme_void() is the easiest way to do this. I also removed the legend using show.legend = FALSE.\n\nggplot(df_long, aes(x = x, next_x = next_x, node = node, next_node = next_node,\n                    fill = factor(node))) +\n        geom_sankey(show.legend = FALSE) +\n        scale_fill_discrete(drop = FALSE) +\n        theme_void()\n\n\n\n\n\n\n\n\nNext I addd node labels onto the Sankey diagram.\n\nggplot(df_long, aes(x = x, next_x = next_x, node = node, next_node = next_node,\n                    fill = factor(node))) +\n        geom_sankey(show.legend = FALSE) +\n        geom_sankey_text(aes(label = node)) +\n        scale_fill_discrete(drop = FALSE) +\n        theme_void()\n\n\n\n\n\n\n\n\nI wanted to change the colours of the links so that each gene would be coloured according to its mechanism using a more visually appealing colour palette (IMO) compared with the default colours. First an extra column was added to the long dataframe to group the genes and mechanism rows by mechanism.\n\nmechanism_lookup &lt;- df %&gt;%\n        select(gene, mechanism) %&gt;%\n        rename(node = gene) %&gt;%\n        bind_rows(df %&gt;% distinct(mechanism) %&gt;% rename(node = mechanism) %&gt;% mutate(mechanism = node)) %&gt;%\n        distinct()\n\n# Add mechanism info to the long data\ndf_long_coloured &lt;- df_long %&gt;%\n        left_join(mechanism_lookup, by = \"node\")\n\nhead(df_long_coloured)\n\n# A tibble: 6 × 5\n  x         node                 next_x    next_node            mechanism       \n  &lt;fct&gt;     &lt;chr&gt;                &lt;fct&gt;     &lt;chr&gt;                &lt;chr&gt;           \n1 gene      ompC*                mechanism Reduced permeability Reduced permeab…\n2 mechanism Reduced permeability subclass  NS penicillins       Reduced permeab…\n3 subclass  NS penicillins       &lt;NA&gt;      &lt;NA&gt;                 &lt;NA&gt;            \n4 gene      ompC*                mechanism Reduced permeability Reduced permeab…\n5 mechanism Reduced permeability subclass  ES penicillins       Reduced permeab…\n6 subclass  ES penicillins       &lt;NA&gt;      &lt;NA&gt;                 &lt;NA&gt;            \n\n\nI selected my colours using https://r-graph-gallery.com/color-palette-finder. Shades of blue from the seeblau palette were used for the “Reduced permeability” and “Efflux pump” mechanisms. Shades of yellow, orange, and red from the amber_material palette were used for the beta-lactamase enzyme types.\n\n#The two palettes that I selected my colours from:\npaletteer_d(\"unikn::pal_seeblau\")\n\n&lt;colors&gt;\n#CCEEF9FF #A6E1F4FF #59C7EBFF #00A9E0FF #008ECEFF \n\npaletteer_d(\"ggsci::amber_material\")\n\n&lt;colors&gt;\n#FFF8E1FF #FFECB3FF #FFE082FF #FFD54FFF #FFCA28FF #FFC107FF #FFB300FF #FFA000FF #FF8F00FF #FF6F00FF \n\n\nI defined my colour palette. All the antibiotic subclasses were defined as “other”.\n\nmy_colour &lt;- c(\n        \"Reduced permeability\" = \"#A6E1F4FF\",      \n        \"Efflux pump\" = \"#0F7BA2FF\",         \n        \"Penicillinases\" = \"#FFECB3FF\",\n        \"Oxcillinases\" = \"#FFD54FFF\", \n        \"IRT\" = \"#FFC107FF\", \n        \"ESBL\" = \"#FFA000FF\",\n        \"AmpC\" = \"#FF6F00FF\", \n        \"Carbapenemases\" = \"#DA291CFF\",\n        \"Other\" = \"#B3B7B8FF\" )\n\nI filled the links by the new mechanism variable.\n\nggplot(df_long_coloured, aes(x = x, next_x = next_x, node = node, next_node = next_node,\n                    fill = mechanism)) +\n        geom_sankey(show.legend = FALSE) +\n        geom_sankey_text(aes(label = node)) +\n        scale_fill_discrete(drop = FALSE) +\n        theme_void()\n\n\n\n\n\n\n\n\nAlthough I now have the same colour for each mechanism, my colour palette has not been used. scale_fill_discrete() was changed to scale_fill_manual(). The colours on the links were very bright so to make them slightly transparent I used the argument flow.alpha.\n\nggplot(df_long_coloured, aes(x = x, next_x = next_x, node = node, next_node = next_node,\n                    fill = mechanism)) +\n        geom_sankey(show.legend = FALSE, flow.alpha = 0.7) +\n        geom_sankey_text(aes(label = node)) +\n        scale_fill_manual(values = my_colour) +\n        theme_void()\n\n\n\n\n\n\n\n\nNext I left justified the first column labels and right justified the second column labels. This code was adapted from https://stackoverflow.com/questions/78240951/adjust-labels-on-individual-nodes-in-sankey-diagram-using-ggsankey. Here the function stage() was used to control the stage at which the aesthetics should be mapped.\n\nggplot(df_long_coloured, aes(\n        x = x, next_x = next_x,\n        node = node, next_node = next_node,\n        fill = mechanism, label = node)) +\n        geom_sankey(flow.alpha = 0.7,\n                show.legend = FALSE) +\n        geom_sankey_text(aes(\n          x = stage(x, after_stat = x + 0.1 * case_when(\n                                                  x == 1 ~ -1,    \n                                                  x == 3 ~ 1,     \n                                                  .default = 0)),\n                    hjust = case_when(x == \"gene\" ~ 1,        \n                            x == \"subclass\" ~ 0, \n                            .default = 0.5))) +\n        theme_void() +\n        scale_fill_manual(values = my_colour)\n\n\n\n\n\n\n\n\nNext I reordered the nodes. See https://github.com/davidsjoberg/ggsankey/issues/7 for more explanation on how to reorder nodes.\n\ndf_long_coloured2 &lt;- df_long_coloured\n\ndf_long_coloured2$node &lt;- factor(\n  df_long_coloured$node, \n  levels = rev(c(\n    \"ompC*\", \"Reduced permeability\", \"ompF*\", \n    \"acrAB-tolC*\", \"Efflux pump\", \n    \"blaTEM-1\", \"Penicillinases\", \"blaSHV-1\", \n    \"blaOXA-1\", \"Oxcillinases\", \n    \"blaTEM-30\", \"IRT\", \n    \"blaTEM-10\", \"ESBL\", \"blaSHV-12\", \"blaCTX-M-15\", \n    \"blaGES-3\", \"blaVEB-1\", \"blaROB-1\", \"blaTLA-1\", \n    \"ampC*\", \"AmpC\", \n    \"blaCMY-2\", \"blaDHA-1\", \"blaFOX-1\", \"blaACC-4\", \n    \"blaKPC-18\", \"Carbapenemases\", \n    \"blaOXA-48\", \"blaNDM-1\", \"blaIMP-4\",\n    \"NS penicillins\", \"ES penicillins\", \"Monobactams\", \n    \"1G cephalosporins\", \"2G cephalosporins\", \n    \"3G cephalosporins\", \"4G cephalosporins\", \"Carbapenems\"))\n)\n\ndf_long_coloured2$next_node &lt;- factor(\n  df_long_coloured$next_node, \n  levels = rev(c(\"Reduced permeability\", \"Efflux pump\", \"Penicillinases\", \n    \"Oxcillinases\", \"IRT\", \"ESBL\", \"AmpC\", \"Carbapenemases\",\n    \"NS penicillins\", \"ES penicillins\",\"Monobactams\",\"1G cephalosporins\",\n    \"Carbapenems\",\"2G cephalosporins\",\"3G cephalosporins\", \"4G cephalosporins\"))\n)\n\nThe plot with the reordered nodes.\n\nggplot(df_long_coloured2, aes(\n        x = x, next_x = next_x,\n        node = node, next_node = next_node,\n        fill = mechanism, label = node)) +\n        geom_sankey(flow.alpha = 0.7,\n                show.legend = FALSE) +\n        geom_sankey_text(aes(\n          x = stage(x, after_stat = x + 0.1 *case_when(\n                                                  x == 1 ~ -1,    \n                                                  x == 3 ~ 1,     \n                                                  .default = 0)),\n                    hjust = case_when(x == \"gene\" ~ 1,        \n                            x == \"subclass\" ~ 0, \n                            .default = 0.5))) +\n        theme_void() +\n        scale_fill_manual(values = my_colour)\n\n\n\n\n\n\n\n\nI italicised the gene names and changed the mechanisms to a bold style using plotmath syntax (if you know of other ways to do this please let me know). First I added another column, which will be used for plotmath syntax, called label_pms. For example to generate x in italic font is written as italic(x). To see more on plotmath syntax see this link https://www.rdocumentation.org/packages/grDevices/versions/3.6.2/topics/plotmath. The paste() function was used to join strings together with no separator. I joined either the string \"italic('\", \"bold('\", or \"plain('\" with the node value (so the gene name), and the string \"')\". Then I changed those labels with a bla gene so that the enzyme type was written in subscript. The function str_replace_all() was used to replace any text with the literal string italic\\\\( followed by bla with the pattern of three word characters\\\\w{3}, a literal hyphen -, one word character \\\\w followed by one or more digits \\\\d or (|) the pattern of three word characters, hyphen, multiple digits.\n\n#Add a new column called label_pms with the plotmath syntax for font styling\ndf_long_coloured3 &lt;- df_long_coloured2 %&gt;%\n  mutate(label_pms = case_when(\n    x == \"gene\" ~ paste0(\"italic('\", node, \"')\"),          \n    x == \"mechanism\" ~ paste0(\"bold('\", node, \"')\"),       \n    x == \"subclass\" ~ paste0(\"plain('\", node, \"')\")        \n  ))\n\n#Change the bla gene labels to subscript after bla\ndf_long_coloured3 &lt;- df_long_coloured3 %&gt;%\n  mutate(label_pms = str_replace_all(label_pms,                                \"italic\\\\('(bla)(\\\\w{3}-\\\\w-\\\\d+|\\\\w{3}-\\\\d+)'\\\\)\", \n                               \"italic('\\\\1')[\\\\2]\"))\n\nNote that when you change the order of your nodes, you also need to set the levels for your labels so that they match the same order as your nodes.\n\ndf_long_coloured3$label_pms &lt;- factor(\n  df_long_coloured3$label_pms,\n  levels = rev(c(\n    \"italic('ompC*')\",\n    \"bold('Reduced permeability')\",\n    \"italic('ompF*')\",\n    \"italic('acrAB-tolC*')\",\n    \"bold('Efflux pump')\",\n    \"italic('bla')[TEM-1]\",\n    \"bold('Penicillinases')\",\n    \"italic('bla')[SHV-1]\",\n    \"italic('bla')[OXA-1]\",\n    \"bold('Oxcillinases')\",\n    \"italic('bla')[TEM-30]\",\n    \"bold('IRT')\",\n    \"italic('bla')[TEM-10]\",\n    \"bold('ESBL')\",\n    \"italic('bla')[SHV-12]\",\n    \"italic('bla')[CTX-M-15]\",\n    \"italic('bla')[GES-3]\",\n    \"italic('bla')[VEB-1]\",\n    \"italic('bla')[ROB-1]\",\n    \"italic('bla')[TLA-1]\",\n    \"italic('ampC*')\",\n    \"bold('AmpC')\",\n    \"italic('bla')[CMY-2]\",\n    \"italic('bla')[DHA-1]\",\n    \"italic('bla')[FOX-1]\",\n    \"italic('bla')[ACC-4]\",\n    \"italic('bla')[KPC-18]\",\n    \"bold('Carbapenemases')\",\n    \"italic('bla')[OXA-48]\",\n    \"italic('bla')[NDM-1]\",\n    \"italic('bla')[IMP-4]\",\n    # Now the antibiotic subclasses in your desired order:\n    \"plain('NS penicillins')\",\n    \"plain('ES penicillins')\",\n    \"plain('Monobactams')\",\n    \"plain('1G cephalosporins')\",\n    \"plain('2G cephalosporins')\",\n    \"plain('3G cephalosporins')\",\n    \"plain('4G cephalosporins')\",\n    \"plain('Carbapenems')\"\n  ))\n)\n\nWhen calling the ggplot() function I then added the arguments label = label_pms and parse = TRUE, to parse it as plotmath syntax.\n\nps &lt;- ggplot(df_long_coloured3, aes(\n    x = x, next_x = next_x,\n    node = node, next_node = next_node,\n    fill = mechanism, label_pms = node)) +\n  geom_sankey(flow.alpha = 0.7, show.legend = FALSE) +\n  geom_sankey_text(\n    aes(label = label_pms,\n        x = stage(x, after_stat = x + 0.1 *\n          case_when(\n            x == 1 ~ -1,\n            x == 3 ~ 1,\n            .default = 0)),\n        hjust = case_when(x == \"gene\" ~ 1,\n                          x == \"subclass\" ~ 0,\n                          .default = 0.5)),\n    parse = TRUE) +\n  theme_void() +\n  scale_fill_manual(values = my_colour)\n\nps\n\n\n\n\n\n\n\n\nLastly I added a caption.\n\ncaption1 &lt;- \"Beta-lactam resistance in &lt;i&gt;E. coli&lt;/i&gt; predominantly occurs through the acquisition of genes encoding beta-lactamases (shades of yellow, orange, and red, according to enzyme group), but can also occur through mutations in genes encoding outer membrane proteins (light blue) or efflux pumps (dark blue); genes with mutations are marked with an asterisk. This Sankey diagram illustrates how beta-lactam resistance genes can be grouped by mechanism (reduced permeability, efflux pump and enzymatic inactivation by different beta-lactamases) and the subclasses of beta-lactams (NS - narrow spectrum and ES - extended spectrum penicllins; monobactams; 1G - first generation, 2G - second generation, 3G - third generation, 4G - fourth generation; and carbapenems) to which they confer resistance. The beta-lactamase enzymes have been grouped into penicillinases, oxacillinases, IRT (inhibitor resistant TEM), ESBL, AmpC, and carbapenemases. One representative gene variant is shown. However, resistance profiles can vary between different variants of the same enzyme and between different enzymes from the same group.\"\n\n\npsc &lt;- ps +\n  labs(caption = caption1) +\n  theme(plot.caption.position = \"plot\", \n        plot.caption = element_textbox_simple(\n          hjust = 0.5, \n          margin = margin(t = 40, r = 5, b = 5, l = 5)))\npsc\n\n\n\n\n\n\n\n#ggsave(\"output/ggsankey_final.png\", plot = psc, width = 12, height = 0.67 * 12, dpi = 300)\n\nBeta-lactamase enzymes can be grouped by Ambler class (based on the amino acid sequence) or the Bush functional group (based on substrate and inhibitor activity). I’d like people to use the Sankey diagram as a reference, so I thought it would be useful to also add in a heat map to identify the Ambler class and Bush functional group of each enzyme. This will be attached to the Sankey diagram.\n\ncg &lt;- read_csv(\"data/class_group.csv\")\n\nRows: 19 Columns: 4\n── Column specification ────────────────────────────────────────────────────────\nDelimiter: \",\"\nchr (4): Gene, Enzyme, Ambler class, Functional group\n\nℹ Use `spec()` to retrieve the full column specification for this data.\nℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.\n\ncg_long &lt;- cg %&gt;%\n        pivot_longer(cols = c(\"Ambler class\", \"Functional group\"),\n                     names_to = \"Category\", values_to = \"Value\")\n\ncg_long2 &lt;- cg_long\n\ncg_long2$Enzyme &lt;- factor(\n  cg_long2$Enzyme,\n  levels = rev(c(\"TEM-1\", \"SHV-1\", \"OXA-1\", \"TEM-30\", \"TEM-10\", \"SHV-12\", \"CTX-M-15\", \"GES-3\", \"ROB-1\", \"TLA-1\", \"AmpC\", \"CMY-2\", \"DHA-1\", \"FOX-1\", \"ACC-4\", \"KPC-18\", \"OXA-48\", \"NDM-1\", \"IMP-4\")))\n\nggplot(data = cg_long2, aes(x = Category, y = Enzyme, fill = Value)) +\n        geom_tile(color = \"white\", show.legend = FALSE) +\n        geom_text(aes(label = Value), color = \"white\", size = 4) +      \n        coord_equal() +\n        scale_fill_paletteer_d(\"impressionist.colors::la_recolte_des_foins_eragny\") +\n        scale_x_discrete(position = \"top\", labels = label_wrap_gen(10)) +\n        theme_minimal() +\n        theme(axis.title = element_blank(),\n                axis.text.y = element_text(size = 8),\n\n                              panel.grid = element_blank()) \n\n\n\n\n\n\n\n\nThe column widths were too narrow to fit the values and the axis title. So I removed coord_equal(), which makes the the length and the width the same for each tile. Instead I used coord_fixed() to set the ratio.\n\nph &lt;- ggplot(data = cg_long2, aes(x = Category, y = Enzyme, fill = Value)) +\n        geom_tile(color = \"white\", show.legend = FALSE) +\n        geom_text(aes(label = Value), color = \"white\", size = 4) +      \n        scale_fill_paletteer_d(\"impressionist.colors::la_recolte_des_foins_eragny\") +\n        scale_x_discrete(position = \"top\", labels = label_wrap_gen(10)) +\n        coord_fixed(ratio = 0.3) +\n        theme_minimal(base_size = 6) +\n        theme(axis.title = element_blank(),\n                axis.text.y = element_text(size = 8),\n              panel.grid = element_blank()) \n\nph\n\n\n\n\n\n\n\n\nI also generated a caption for this plot\n\ncaption2 &lt;- \"Beta-lactamases can be grouped according to their Ambler class and Bush functional group. Ambler classes are based on amino acid sequence similarity (doi: 10.1042/bj2760269), and Bush functional groups are based on substrate and inhibitor profiles (doi:10.1128/AAC.01009-09).\"\n\nphc &lt;- ph + labs(caption = caption2) +\n  theme(plot.caption.position = \"plot\", \n        plot.caption = element_textbox_simple(\n          lineheight = 0.5,\n          hjust = 0,\n          margin = margin(t = 50, r = 10, b = 5, l = 10)))\n        #plot.margin = margin(t = 5, r = 10, b = 40, l = 10))\n\n#ggsave(\"output/heatmap_final.png\", plot = phc, width = 12, height = 0.67 * 12, dpi = 300)\n\nI joined the Sankey diagram and the heatmap together using the patchwork library\n\np_join &lt;- phc + psc\n\nNext I added the title and subtitle. For adding titles and customising ggplots I would recommend Nicola Rennie’s book ’The Art of Data Visualization with ggplot2”\n\ntitle &lt;- \"Beta-lactam resistance in &lt;i&gt;Escherichia coli&lt;/i&gt;\"\n\nFinally I added my social media and business icons. This code was adapted from Rennie, Nicola. 2023. “Adding Social Media Icons to Charts with {Ggplot2}.” July 27, 2023. https://nrennie.rbind.io/blog/adding-social-media-icons-ggplot2/.\n\nsysfonts::font_add_google(name = \"Baloo 2\", family = \"baloo\")\nsysfonts::font_add(\n  family = \"Font Awesome 7 Brands\",\n  regular = \"fonts/fontawesome-free-7.1.0/otfs/Font-Awesome-7-Brands-Regular-400.otf\"\n)\nshowtext_auto()  # Only need this ONCE, after all fonts are added\nshowtext_opts(dpi = 300)\n\nbrand_font &lt;- \"baloo\"\nbrand_color &lt;- \"#55692f\"\n\ngithub_icon &lt;- \"&#xf09b\"\ngithub_username &lt;- \"sburgess2\"\nlinkedin_icon &lt;- \"&#xf08c\"\nlinkedin_username &lt;- \"sara-burgess\"\n\n#img = image, src = source, span is a span tag for inline styling\nsocial_caption &lt;- glue(\n  \"&lt;img src='logo/GreenhoodLogoMark.png' width='20' height='14.84'/&gt; &lt;span style='color: {brand_color};'&gt;&lt;strong&gt; Sara Burgess&lt;/strong&gt;&lt;/span&gt; |\",\n  \"&lt;span style='font-family:\\\"Font Awesome 7 Brands\\\";'&gt;{github_icon};&lt;/span&gt; \",\n  \"&lt;span style='color: #000000'&gt;{github_username}&lt;/span&gt; | \",\n  \"&lt;span style='font-family:\\\"Font Awesome 7 Brands\\\";'&gt;{linkedin_icon};&lt;/span&gt; \",\n  \"&lt;span style='color: #000000'&gt;{linkedin_username}&lt;/span&gt;\"\n)\n\nThis is what my caption looks like without the plot. As described in Nicole Rennie’s blog the element_text_box_simple() function is added so it can enable Markdown and/or HTML code. The element_text_box() function is very similar but it does not have any default values.\n\nggplot() +\n  labs(caption = social_caption, title = title) +\n  theme(plot.caption = element_textbox_simple(),\n        plot.title = element_textbox_simple())\n\n\n\n\n\n\n\n\nNext I added my caption to the plot. I have used plot_annotation() to add the caption because, I’m using the library patchwork to join the two plots together.\n\n#Note this results in a caption twice under each plot\np_final &lt;- p_join +\n  plot_annotation(caption = social_caption, title = title) &\n  theme(\n    plot.caption = element_textbox_simple(\n  margin = margin(t = 30, r = 10, b = 20, l = 5),\n  size = 8),\n    plot.title = element_textbox_simple(),\n    base_size = 6)\n\np_final\n\n\n\n\n\n\n\n#ggsave(\"output/hm_ggsankey_final.png\", plot = p_final, width = 12, height = 0.67 * 12, dpi = 300)"
  },
  {
    "objectID": "index.html#generating-and-polishing-sankey-diagrams-in-r",
    "href": "index.html#generating-and-polishing-sankey-diagrams-in-r",
    "title": "Resistance genes in Escherichia coli",
    "section": "",
    "text": "There are several R packages that enable Sankey diagrams to be generated. In these two examples I used the networkD3 and ggsankey packages. In this example a Sankey diagram was used to visualise the different resistance genes and mechanisms that E. coli uses to become resistant to six classes of antibiotics. A separate Sankey diagram was used to illustrate beta-lactam resistance as there are so many different beta-lactam resistance genes"
  },
  {
    "objectID": "index.html#data",
    "href": "index.html#data",
    "title": "Resistance genes in Escherichia coli",
    "section": "",
    "text": "In these examples data was manually sourced from publications (as listed at the bottom of this blog) to visualise the different resistance genes and mechanisms that the bacterium Escherichia coli can use to become resistant to seven classes of antibiotics. The first Sankey diagram covers E. coli resistance to six classes of antibiotics (aminoglycosides, fluoroquinolones, tetracyclines, phenicols, sulfonamides and trimethoprim, nitrofurans). The second Sankey diagram shows how different beta-lactamase enzyme types confer resistance to different sub-classes of beta-lactams."
  },
  {
    "objectID": "index.html#generating-a-sankey-diagram-using-ggsankey.",
    "href": "index.html#generating-a-sankey-diagram-using-ggsankey.",
    "title": "Resistance genes in Escherichia coli",
    "section": "",
    "text": "In this example I used the package ggsankey to generate a Sankey diagram. Visualising the beta-lactam resistance genes was not as straight forward as the other resistance genes in the Sankey diagram above. There are multiple enzyme types, which all have a large number of variants. Certain variants have a wider range of resistance compared with their parent types, which adds in more complexity. For this reason I started with the genes on the left hand side.\n\n\nInstall the packages ggsankey, showtext and sysfonts, glue, patchwok and ggtext then load the libraries\n\n#remotes::install_github(\"davidsjoberg/ggsankey\")\n\nlibrary(ggsankey)\nlibrary(patchwork)\nlibrary(glue)\nlibrary(showtext)\nlibrary(sysfonts)\nlibrary(ggtext)\n\n\n\n\nNext read in the data.\n\ndf &lt;- read_csv(\"data/betalactams_gsankey.csv\")\n\nMy csv file contains three columns: “gene”, “mechanism”, “subclass”. This data frame is set up differently to the dataframe used for the first Sankey diagram in that each column will be a column in the Sankey diagram. The first column “gene” is the name of each resistance gene. The second column is the mechanism or type of enzyme. Instead of having “enzymatic inactivation” I divided the beta-lactamases into “Penicillinases”, “Oxcillinases”, “IRT” (inhibitor resistant TEM), “ESBL”, “AmpC”, and “Carbapenemases”. In addition, I included the mechanisms “reduced permeability” and “efflux pump”. The third column is the antibiotic subclass. Given most genes confer resistance to multiple sub classes there are multiple rows for each gene.\n\n#Structure of my dataframe\nstr(df)\n\nspc_tbl_ [121 × 3] (S3: spec_tbl_df/tbl_df/tbl/data.frame)\n $ gene     : chr [1:121] \"ompC*\" \"ompC*\" \"ompC*\" \"ompC*\" ...\n $ mechanism: chr [1:121] \"Reduced permeability\" \"Reduced permeability\" \"Reduced permeability\" \"Reduced permeability\" ...\n $ subclass : chr [1:121] \"NS penicillins\" \"ES penicillins\" \"1G cephalosporins\" \"3G cephalosporins\" ...\n - attr(*, \"spec\")=\n  .. cols(\n  ..   gene = col_character(),\n  ..   mechanism = col_character(),\n  ..   subclass = col_character()\n  .. )\n - attr(*, \"problems\")=&lt;externalptr&gt; \n\n#First six lines of my data frame\nhead(df)\n\n# A tibble: 6 × 3\n  gene  mechanism            subclass         \n  &lt;chr&gt; &lt;chr&gt;                &lt;chr&gt;            \n1 ompC* Reduced permeability NS penicillins   \n2 ompC* Reduced permeability ES penicillins   \n3 ompC* Reduced permeability 1G cephalosporins\n4 ompC* Reduced permeability 3G cephalosporins\n5 ompC* Reduced permeability Carbapenems      \n6 ompF* Reduced permeability NS penicillins   \n\n#Last six lines of my data frame\ntail(df)\n\n# A tibble: 6 × 3\n  gene     mechanism      subclass         \n  &lt;chr&gt;    &lt;chr&gt;          &lt;chr&gt;            \n1 blaNDM-1 Carbapenemases Carbapenems      \n2 blaIMP-4 Carbapenemases 1G cephalosporins\n3 blaIMP-4 Carbapenemases 2G cephalosporins\n4 blaIMP-4 Carbapenemases 3G cephalosporins\n5 blaIMP-4 Carbapenemases 4G cephalosporins\n6 blaIMP-4 Carbapenemases Carbapenems      \n\n#The unique mechanisms / enzyme types\nunique(df$mechanism)\n\n[1] \"Reduced permeability\" \"Efflux pump\"          \"Penicillinases\"      \n[4] \"Oxcillinases\"         \"IRT\"                  \"ESBL\"                \n[7] \"AmpC\"                 \"Carbapenemases\"      \n\n#The unique subclasses of antibiotics\nunique(df$subclass)\n\n[1] \"NS penicillins\"    \"ES penicillins\"    \"1G cephalosporins\"\n[4] \"3G cephalosporins\" \"Carbapenems\"       \"4G cephalosporins\"\n[7] \"Monobactams\"       \"2G cephalosporins\"\n\n\nNext, the data was converted to a long format using a function make_long() from the ggsankey package. This long format contains columns that define how the links flow through the diagram:\n\nx: the name of the current column (called a stage) on the x axis.\nnext_x: the name of the next stage (NA for the final stage which is why the subclass rows have NA values).\nnode: the value at the starting node.\nnext_node: the value at the connecting node.\n\nThe following code was adapted from the r-graph-gallery.\n\ndf_long &lt;- df %&gt;%\n        make_long(gene, mechanism, subclass)\n\nhead(df_long)\n\n# A tibble: 6 × 4\n  x         node                 next_x    next_node           \n  &lt;fct&gt;     &lt;chr&gt;                &lt;fct&gt;     &lt;chr&gt;               \n1 gene      ompC*                mechanism Reduced permeability\n2 mechanism Reduced permeability subclass  NS penicillins      \n3 subclass  NS penicillins       &lt;NA&gt;      &lt;NA&gt;                \n4 gene      ompC*                mechanism Reduced permeability\n5 mechanism Reduced permeability subclass  ES penicillins      \n6 subclass  ES penicillins       &lt;NA&gt;      &lt;NA&gt;                \n\n\nHere is a first look at how the data looks when it is plotted.\n\nggplot(df_long, aes(x = x, next_x = next_x, node = node, next_node = next_node)) +\n        geom_sankey()\n\n\n\n\n\n\n\n\nHere is the same plot with the links and nodes coloured by node.\n\nggplot(df_long, aes(x = x, next_x = next_x, node = node, next_node = next_node,\n                    fill = factor(node))) +\n        geom_sankey() +\n        scale_fill_discrete(drop = FALSE)\n\n\n\n\n\n\n\n\nThere is a lot to tidy up. First I removed the grey background, the grid, and x and y axis labels. I find that using theme_void() is the easiest way to do this. I also removed the legend using show.legend = FALSE.\n\nggplot(df_long, aes(x = x, next_x = next_x, node = node, next_node = next_node,\n                    fill = factor(node))) +\n        geom_sankey(show.legend = FALSE) +\n        scale_fill_discrete(drop = FALSE) +\n        theme_void()\n\n\n\n\n\n\n\n\nNext I added node labels.\n\nggplot(df_long, aes(x = x, next_x = next_x, node = node, next_node = next_node,\n                    fill = factor(node))) +\n        geom_sankey(show.legend = FALSE) +\n        geom_sankey_text(aes(label = node)) +\n        scale_fill_discrete(drop = FALSE) +\n        theme_void()\n\n\n\n\n\n\n\n\nI wanted to change the colours of the links so that each gene would be coloured according to its mechanism using a more visually appealing colour palette compared with the default colours. First an extra column was added to the long dataframe to group the genes and mechanism rows by mechanism.\n\nmechanism_lookup &lt;- df %&gt;%\n        select(gene, mechanism) %&gt;%\n        rename(node = gene) %&gt;%\n        bind_rows(\n                df %&gt;% \n                        distinct(mechanism) %&gt;% \n                        rename(node = mechanism) %&gt;% \n                        mutate(mechanism = node)) %&gt;%\n        distinct()\n\n# Add mechanism info to the long data\ndf_long_coloured &lt;- df_long %&gt;%\n        left_join(mechanism_lookup, by = \"node\")\n\nhead(df_long_coloured)\n\n# A tibble: 6 × 5\n  x         node                 next_x    next_node            mechanism       \n  &lt;fct&gt;     &lt;chr&gt;                &lt;fct&gt;     &lt;chr&gt;                &lt;chr&gt;           \n1 gene      ompC*                mechanism Reduced permeability Reduced permeab…\n2 mechanism Reduced permeability subclass  NS penicillins       Reduced permeab…\n3 subclass  NS penicillins       &lt;NA&gt;      &lt;NA&gt;                 &lt;NA&gt;            \n4 gene      ompC*                mechanism Reduced permeability Reduced permeab…\n5 mechanism Reduced permeability subclass  ES penicillins       Reduced permeab…\n6 subclass  ES penicillins       &lt;NA&gt;      &lt;NA&gt;                 &lt;NA&gt;            \n\n\nI selected my colours using the r-graph-gallery color-palette-finder. Shades of blue from the seeblau palette were used for the “Reduced permeability” and “Efflux pump” mechanisms. Shades of yellow, orange, and red from the amber_material palette were used for the beta-lactamase enzyme types.\n\n#The two palettes that I selected my colours from:\npaletteer_d(\"unikn::pal_seeblau\")\n\n&lt;colors&gt;\n#CCEEF9FF #A6E1F4FF #59C7EBFF #00A9E0FF #008ECEFF \n\npaletteer_d(\"ggsci::amber_material\")\n\n&lt;colors&gt;\n#FFF8E1FF #FFECB3FF #FFE082FF #FFD54FFF #FFCA28FF #FFC107FF #FFB300FF #FFA000FF #FF8F00FF #FF6F00FF \n\n\nI defined my colour palette. All the antibiotic classes were defined as “other”.\n\nmy_colour &lt;- c(\n        \"Reduced permeability\" = \"#A6E1F4FF\",      \n        \"Efflux pump\" = \"#0F7BA2FF\",         \n        \"Penicillinases\" = \"#FFECB3FF\",\n        \"Oxcillinases\" = \"#FFD54FFF\", \n        \"IRT\" = \"#FFC107FF\", \n        \"ESBL\" = \"#FFA000FF\",\n        \"AmpC\" = \"#FF6F00FF\", \n        \"Carbapenemases\" = \"#DA291CFF\",\n        \"Other\" = \"#B3B7B8FF\" )\n\nI filled the links by the new mechanism variable.\n\nggplot(\n        df_long_coloured, \n        aes(x = x, next_x = next_x, node = node, next_node = next_node,\n                    fill = mechanism)) +\n        geom_sankey(show.legend = FALSE) +\n        geom_sankey_text(aes(label = node)) +\n        scale_fill_discrete(drop = FALSE) +\n        theme_void()\n\n\n\n\n\n\n\n\nAlthough I now have the same colour for each mechanism, my colour palette has not been used therefore, scale_fill_discrete() was changed to scale_fill_manual(). The colours on the links were very bright so to make them slightly transparent I used the argument flow.alpha.\n\nggplot(\n        df_long_coloured, \n        aes(x = x, next_x = next_x, node = node, next_node = next_node,\n                    fill = mechanism)) +\n        geom_sankey(show.legend = FALSE) +\n        geom_sankey_text(aes(label = node)) +\n        scale_fill_manual(values = my_colour) +\n        theme_void() \n\n\n\n\n\n\n\n\nNext I left justified the first column labels and right justified the second column labels. This code was adapted from this stack overflow post. Here the function stage() was used to control the stage at which the aesthetics should be mapped.\n\nggplot(\n        df_long_coloured, \n        aes(x = x, next_x = next_x,\n        node = node, next_node = next_node,\n        fill = mechanism, label = node)) +\n        geom_sankey(flow.alpha = 0.7,\n                show.legend = FALSE) +\n        geom_sankey_text(\n                aes(\n          x = stage(x, after_stat = x + 0.1 * case_when(\n                                                  x == 1 ~ -1,    \n                                                  x == 3 ~ 1,     \n                                                  .default = 0)),\n                    hjust = case_when(x == \"gene\" ~ 1,        \n                            x == \"subclass\" ~ 0, \n                            .default = 0.5))) +\n        theme_void() +\n        scale_fill_manual(values = my_colour)\n\n\n\n\n\n\n\n\nNext I reordered the nodes. See this link for more explanation on how to reorder nodes.\n\ndf_long_coloured2 &lt;- df_long_coloured\n\ndf_long_coloured2$node &lt;- factor(\n  df_long_coloured$node, \n  levels = rev(c(\n    \"ompC*\", \"Reduced permeability\", \"ompF*\", \n    \"acrAB-tolC*\", \"Efflux pump\", \n    \"blaTEM-1\", \"Penicillinases\", \"blaSHV-1\", \n    \"blaOXA-1\", \"Oxcillinases\", \n    \"blaTEM-30\", \"IRT\", \n    \"blaTEM-10\", \"ESBL\", \"blaSHV-12\", \"blaCTX-M-15\", \n    \"blaGES-3\", \"blaVEB-1\", \"blaROB-1\", \"blaTLA-1\", \n    \"ampC*\", \"AmpC\", \n    \"blaCMY-2\", \"blaDHA-1\", \"blaFOX-1\", \"blaACC-4\", \n    \"blaKPC-18\", \"Carbapenemases\", \n    \"blaOXA-48\", \"blaNDM-1\", \"blaIMP-4\",\n    \"NS penicillins\", \"ES penicillins\", \"Monobactams\", \n    \"1G cephalosporins\", \"2G cephalosporins\", \n    \"3G cephalosporins\", \"4G cephalosporins\", \"Carbapenems\"))\n)\n\ndf_long_coloured2$next_node &lt;- factor(\n  df_long_coloured$next_node, \n  levels = rev(c(\"Reduced permeability\", \"Efflux pump\", \"Penicillinases\", \n    \"Oxcillinases\", \"IRT\", \"ESBL\", \"AmpC\", \"Carbapenemases\",\n    \"NS penicillins\", \"ES penicillins\",\"Monobactams\",\"1G cephalosporins\",\n    \"Carbapenems\",\"2G cephalosporins\",\"3G cephalosporins\", \"4G cephalosporins\"))\n)\n\nThe plot with the reordered nodes.\n\nggplot(df_long_coloured2, aes(\n        x = x, next_x = next_x,\n        node = node, next_node = next_node,\n        fill = mechanism, label = node)) +\n        geom_sankey(flow.alpha = 0.7,\n                show.legend = FALSE) +\n        geom_sankey_text(aes(\n          x = stage(x, after_stat = x + 0.1 *case_when(\n                                                  x == 1 ~ -1,    \n                                                  x == 3 ~ 1,     \n                                                  .default = 0)),\n                    hjust = case_when(x == \"gene\" ~ 1,        \n                            x == \"subclass\" ~ 0, \n                            .default = 0.5))) +\n        theme_void() +\n        scale_fill_manual(values = my_colour)\n\n\n\n\n\n\n\n\nI italicised the gene names and changed the mechanisms to a bold style using plotmath syntax. First I added another column, which will be used for plotmath syntax, called label_pms. For example, to generate x in italic font use italic(x). Go to this link to read more on plotmath syntax. The paste() function was used to join strings together with no separator. I joined either the string \"italic('\", \"bold('\", or \"plain('\" with the node value (so the gene name), and the string \"')\". Then I changed those labels with a bla gene so that the enzyme type was written in subscript. The function str_replace_all() was used to replace any text with the literal string italic\\\\( followed by bla with the pattern of three word characters\\\\w{3}, a literal hyphen -, one word character \\\\w followed by one or more digits \\\\d or (|) the pattern of three word characters, hyphen, multiple digits.\n\n#Add a new column called label_pms with the plotmath syntax for font styling\ndf_long_coloured3 &lt;- df_long_coloured2 %&gt;%\n  mutate(label_pms = case_when(\n    x == \"gene\" ~ paste0(\"italic('\", node, \"')\"),          \n    x == \"mechanism\" ~ paste0(\"bold('\", node, \"')\"),       \n    x == \"subclass\" ~ paste0(\"plain('\", node, \"')\")        \n  ))\n\n#Change the bla gene labels to subscript after bla\ndf_long_coloured3 &lt;- df_long_coloured3 %&gt;%\n  mutate(label_pms = str_replace_all(label_pms,                                \"italic\\\\('(bla)(\\\\w{3}-\\\\w-\\\\d+|\\\\w{3}-\\\\d+)'\\\\)\", \n                               \"italic('\\\\1')[\\\\2]\"))\n\nNote that when you change the order of your nodes, you also need to set the levels for your labels so that they match the same order as your nodes.\n\ndf_long_coloured3$label_pms &lt;- factor(\n  df_long_coloured3$label_pms,\n  levels = rev(c(\n    \"italic('ompC*')\",\n    \"bold('Reduced permeability')\",\n    \"italic('ompF*')\",\n    \"italic('acrAB-tolC*')\",\n    \"bold('Efflux pump')\",\n    \"italic('bla')[TEM-1]\",\n    \"bold('Penicillinases')\",\n    \"italic('bla')[SHV-1]\",\n    \"italic('bla')[OXA-1]\",\n    \"bold('Oxcillinases')\",\n    \"italic('bla')[TEM-30]\",\n    \"bold('IRT')\",\n    \"italic('bla')[TEM-10]\",\n    \"bold('ESBL')\",\n    \"italic('bla')[SHV-12]\",\n    \"italic('bla')[CTX-M-15]\",\n    \"italic('bla')[GES-3]\",\n    \"italic('bla')[VEB-1]\",\n    \"italic('bla')[ROB-1]\",\n    \"italic('bla')[TLA-1]\",\n    \"italic('ampC*')\",\n    \"bold('AmpC')\",\n    \"italic('bla')[CMY-2]\",\n    \"italic('bla')[DHA-1]\",\n    \"italic('bla')[FOX-1]\",\n    \"italic('bla')[ACC-4]\",\n    \"italic('bla')[KPC-18]\",\n    \"bold('Carbapenemases')\",\n    \"italic('bla')[OXA-48]\",\n    \"italic('bla')[NDM-1]\",\n    \"italic('bla')[IMP-4]\",\n    # Now the antibiotic subclasses in your desired order:\n    \"plain('NS penicillins')\",\n    \"plain('ES penicillins')\",\n    \"plain('Monobactams')\",\n    \"plain('1G cephalosporins')\",\n    \"plain('2G cephalosporins')\",\n    \"plain('3G cephalosporins')\",\n    \"plain('4G cephalosporins')\",\n    \"plain('Carbapenems')\"\n  ))\n)\n\nWhen calling the ggplot() function I then added the arguments label = label_pms and parse = TRUE, to parse it as plotmath syntax.\n\nps &lt;- ggplot(df_long_coloured3, aes(\n    x = x, next_x = next_x,\n    node = node, next_node = next_node,\n    fill = mechanism, label_pms = node)) +\n  geom_sankey(flow.alpha = 0.7, show.legend = FALSE) +\n  geom_sankey_text(\n    aes(label = label_pms,\n        x = stage(x, after_stat = x + 0.1 *\n          case_when(\n            x == 1 ~ -1,\n            x == 3 ~ 1,\n            .default = 0)),\n        hjust = case_when(x == \"gene\" ~ 1,\n                          x == \"subclass\" ~ 0,\n                          .default = 0.5)),\n    parse = TRUE) +\n  theme_void() +\n  scale_fill_manual(values = my_colour)\n\nps\n\n\n\n\n\n\n\n\nLastly I added a caption. For adding captions, titles and customising ggplots I would recommend Nicola Rennie’s book ’The Art of Data Visualization with ggplot2”\n\ncaption1 &lt;- \"Beta-lactam resistance in &lt;i&gt;E. coli&lt;/i&gt; predominantly occurs through the acquisition of genes encoding beta-lactamases (shades of yellow, orange, and red, according to enzyme group), but can also occur through mutations in genes encoding outer membrane proteins (light blue) or efflux pumps (dark blue); genes with mutations are marked with an asterisk. This Sankey diagram illustrates how beta-lactam resistance genes can be grouped by mechanism (reduced permeability, efflux pump and enzymatic inactivation by different beta-lactamases) and the subclasses of beta-lactams (NS - narrow spectrum and ES - extended spectrum penicllins; monobactams; 1G - first generation, 2G - second generation, 3G - third generation, 4G - fourth generation; and carbapenems) to which they confer resistance. The beta-lactamase enzymes have been grouped into penicillinases, oxacillinases, IRT (inhibitor resistant TEM), ESBL, AmpC, and carbapenemases. One representative gene variant is shown. However, resistance profiles can vary between different variants of the same enzyme and between different enzymes from the same group.\"\n\n\npsc &lt;- ps +\n  labs(caption = caption1) +\n  theme(plot.caption.position = \"plot\", \n        plot.caption = element_textbox_simple(\n          hjust = 0.5, \n          margin = margin(t = 40, r = 5, b = 5, l = 5)))\npsc\n\n\n\n\n\n\n\n\nTo attribute this work please cite:\nBurgess, Sara. 2025. “Generating and polishing Sankey diagrams in R.” 14 November, 2025. https://sburgess2.github.io/sankey_amr/"
  }
]